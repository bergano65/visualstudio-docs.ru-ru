---
title: Как работает Bridge to Kubernetes
ms.technology: vs-azure
ms.date: 11/19/2020
ms.topic: conceptual
description: Описываются процессы использования функции Bridge to Kubernetes для подключения компьютера разработчика к кластеру Kubernetes.
keywords: Bridge to Kubernetes, Docker, Kubernetes, Azure, контейнеры
monikerRange: '>=vs-2019'
manager: jmartens
author: ghogen
ms.author: ghogen
ms.openlocfilehash: 253b50ff4778458b28375b06b7fb7f24f4d85054
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99867572"
---
# <a name="how-bridge-to-kubernetes-works"></a>Как работает Bridge to Kubernetes

Bridge to Kubernetes позволяет выполнять и отлаживать код на компьютере разработки, подключенном к кластеру Kubernetes, в котором находятся остальные приложения или службы. Например, при наличии масштабной архитектуры микрослужб со множеством взаимозависимых служб и баз данных репликация этих зависимостей на компьютере разработки может представлять сложность. Кроме того, сборка и развертывание кода в кластере Kubernetes при каждом изменении кода в процессе внутреннего цикла разработки могут занимать много времени и затруднять использование отладчика.

Функция Bridge to Kubernetes избавляет от необходимости выполнять сборку кода и развертывать его в кластере благодаря прямому подключению между компьютером разработки и кластером. Подключение компьютера разработки к кластеру во время отладки позволяет быстро тестировать и разрабатывать службу в контексте полного приложения, не создавая конфигурацию Docker или Kubernetes.

Bridge to Kubernetes перенаправляет трафик между подключенным кластером Kubernetes и компьютером разработки. Это перенаправление трафика позволяет коду на компьютере разработки и службам, работающим в кластере Kubernetes, взаимодействовать так, как если бы они находились в одном кластере Kubernetes. Bridge to Kubernetes также позволяет реплицировать переменные среды и подключенные тома, доступные модулям pod в кластере Kubernetes, на компьютере разработки. Наличие доступа к переменным среды и подключенным томам на компьютере разработки позволяет быстро работать с кодом, не реплицируя эти зависимости вручную.

> [!WARNING]
> Функция Bridge to Kubernetes предназначена для использования только в сценариях разработки и тестирования. Он не предназначен для выполнения с рабочими кластерами или службами Live в активном использовании.

## <a name="using-bridge-to-kubernetes"></a>Использование Bridge to Kubernetes

Чтобы использовать функцию Bridge to Kubernetes в Visual Studio, требуется [Visual Studio 2019][visual-studio] версии 16.7, предварительная версия 4, или более поздней версии в ОС Windows 10 с установленной рабочей нагрузкой *ASP.NET и разработка веб-приложений* и [расширением Bridge to Kubernetes][btk-extension]. При использовании функции Bridge to Kubernetes для установления подключения к кластеру Kubernetes можно настроить перенаправление всего входящего и исходящего трафика для существующего модуля pod в кластере на компьютер разработки.

> [!NOTE]
> При использовании Bridge to Kubernetes вам будет предложено ввести имя службы, трафик которой должен перенаправляться на компьютер разработки. Это удобный способ для указания перенаправляемого модуля pod. Перенаправление между кластером Kubernetes и компьютером разработки осуществляется только для модуля pod.

Когда функция Bridge to Kubernetes устанавливает подключение к кластеру, она выполняет следующие действия.

* Выводит запрос на настройку службы, которую следует заменить в кластере, порта на компьютере разработки, который следует использовать для кода, и задачи запуска для кода. Настройка выполняется один раз.
* Заменяет контейнер в модуле pod в кластере контейнером удаленного агента, который перенаправляет трафик на компьютер разработки.
* Выполняет команду [kubectl port-forward][kubectl-port-forward] на компьютере разработки для перенаправления трафика с компьютера разработки в удаленный агент, запущенный в кластере.
* Собирает сведения о среде из кластера с помощью удаленного агента. Эти сведения включают в себя переменные среды, видимые службы, подключенные тома и подключенные секреты.
* Настраивает среду в Visual Studio так, чтобы служба на компьютере разработки могла получать доступ к переменным так же, как если бы она выполнялась в кластере.
* Обновляет файл hosts, сопоставляя службы в кластере с локальными IP-адресами на компьютере разработки. Эти записи в файле hosts позволяют коду, выполняющемуся на компьютере разработки, совершать запросы к другим службам, работающим в кластере. Чтобы обновить файл hosts, функция Bridge to Kubernetes запрашивает у администратора права доступа на компьютере разработки при подключении к кластеру.
* Начинает выполнять и отлаживать код на компьютере разработки. При необходимости Bridge to Kubernetes освобождает необходимые порты на компьютере разработки, останавливая использующие их службы или процессы.

После установления подключения к кластеру можно выполнять и отлаживать код на локальном компьютере без использования контейнеров, причем код может напрямую взаимодействовать с остальным кластером. Весь сетевой трафик, получаемый удаленным агентом, перенаправляется на локальный порт, указанный во время подключения, чтобы выполняемый локально код мог принимать и обрабатывать его. Переменные среды, тома и секреты из кластера доступны коду, выполняемому на компьютере разработки. Кроме того, благодаря добавлению записей в файл hosts и перенаправлению портов на компьютере разработки посредством функции Bridge to Kubernetes ваш код может отправлять сетевой трафик в службы, работающие в кластере, используя их имена, и этот трафик перенаправляется в службы, работающие в кластере. Трафик маршрутизируется между компьютером разработки и кластером в течение всего времени подключения.

Кроме того, Bridge to Kubernetes позволяет реплицировать переменные среды и подключенные файлы, доступные модулям pod в кластере, на компьютере разработки через файл `KubernetesLocalProcessConfig.yaml`. Этот файл также можно использовать для создания новых переменных среды и подключений томов.

> [!NOTE]
> На протяжении всего сеанса подключения к кластеру (и еще 15 минут) функция Bridge to Kubernetes выполняет на локальном компьютере процесс *EndpointManager* с разрешениями администратора.

## <a name="additional-configuration-with-kuberneteslocalprocessconfigyaml"></a>Дополнительная настройка с помощью KubernetesLocalProcessConfig.yaml

Файл `KubernetesLocalProcessConfig.yaml` позволяет реплицировать переменные среды и подключенные файлы, доступные для групп pod в кластере. Сведения о дополнительных параметрах конфигурации см. в статье [Настройка Bridge to Kubernetes][using-config-yaml].

## <a name="using-routing-capabilities-for-developing-in-isolation"></a>Использование возможностей маршрутизации для разработки в изоляции

По умолчанию Bridge to Kubernetes перенаправляет на компьютер разработки весь трафик службы. Кроме того, можно использовать возможности маршрутизации, чтобы перенаправлять запросы к только службе, которая выполняется из поддомена на компьютере разработчика. Эти возможности маршрутизации позволяют использовать Bridge to Kubernetes для разработки в изоляции и предотвращения помех для другого трафика в кластере.

В следующей анимации показаны два разработчика, работающие над одним кластером в изоляции:

![Анимированный GIF, иллюстрирующий изоляцию](media/bridge-to-kubernetes/btk-graphic-isolated.gif)

При работе в изоляции Bridge to Kubernetes выполняет следующие действия в дополнение к подключению к кластеру Kubernetes:

* Проверяет, что в кластере Kubernetes не включена служба Azure Dev Spaces.
* Реплицирует выбранную службу в кластер в том же пространстве имен и добавляет метку *routing.visualstudio.io/route-from=SERVICE_NAME* и аннотацию *routing.visualstudio.io/route-on-header=kubernetes-route-as: GENERATED_NAME*.
* Настраивает и запускает диспетчер маршрутизации в том же пространстве имен в кластере Kubernetes. Диспетчер маршрутизации использует селектор меток для поиска метки *routing.visualstudio.io/route-from=SERVICE_NAME* и аннотации *routing.visualstudio.io/route-on-header=kubernetes-route-as: GENERATED_NAME* при настройке маршрутизации в вашем пространстве имен.

Если Bridge to Kubernetes обнаруживает, что в кластере Kubernetes включена служба Azure Dev Spaces, вам будет предложено отключить Azure Dev Spaces, прежде чем можно будет использовать Bridge to Kubernetes.

При запуске диспетчер маршрутизации выполняет следующие действия:

* Дублирует весь входящий трафик (включая входящий трафик подсистемы балансировки нагрузки), найденный в пространстве имен, используя *GENERATED_NAME* в качестве поддомена.
* Создает модуль pod – представитель для каждой службы, связанной с повторяющимися входящим трафиком, с поддоменом *GENERATED_NAME*.
* Создает дополнительный модуль pod – представитель для службы, над которой вы работаете в изоляции. Это позволяет перенаправлять запросы с поддоменом на компьютер разработчика.
* Настраивает правила маршрутизации для каждого модуля pod – представителя, чтобы управлять маршрутизацией для служб с поддоменом.

На следующей схеме показан кластер Kubernetes перед подключением Bridge to Kubernetes к нему:

![Схема кластера без Bridge to Kubernetes](media/bridge-to-kubernetes/kubr-cluster.svg)

На приведенной ниже схеме показан тот же кластер с функцией Bridge to Kubernetes, включенной в режиме изоляции. На ней видна дублированная служба и модули pod Envoy, поддерживающие маршрутизацию в режиме изоляции.

![Схема кластера с включенной функцией Bridge to Kubernetes](media/bridge-to-kubernetes/kubr-cluster-devcomputer.svg)

При получении запроса с поддоменом *GENERATED_NAME* в кластере к запросу добавляется заголовок *kubernetes-route-as=GENERATED_NAME*. Модуль pod – представитель обрабатывает маршрутизацию, которая запрашивает соответствующую службу в кластере. Если запрос направляется в службу, которая работает в режиме изоляции, этот запрос перенаправляется удаленным агентом на компьютер разработчика.

При получении запроса с поддоменом *GENERATED_NAME* в кластере к запросу не добавляется заголовок. Модуль pod – представитель обрабатывает маршрутизацию, которая запрашивает соответствующую службу в кластере. Если запрос направляется в заменяемую службу, этот запрос перенаправляется в исходную службу, а не на удаленный агент.

> [!IMPORTANT]
> При выполнении дополнительных запросов каждая служба в кластере должна перенаправить заголовок *kubernetes-route-as=GENERATED_NAME*. Например, когда служба *serviceA* получает запрос, она делает запрос к службе *serviceB*, прежде чем вернуть ответ. В этом примере служба *serviceA* должна перенаправить заголовок *kubernetes-route-as=GENERATED_NAME* в своем запросе к службе *serviceB*. Некоторые языки, например [ASP.NET][asp-net-header], могут предоставлять методы для обработки распространения заголовка.

При отключении от кластера по умолчанию локальный Bridge to Kubernetes удалит все модули pod — представители и дублирующую службу.

> [!NOTE]
> Развертывание и служба диспетчера маршрутизации будут продолжать работать в вашем пространстве имен. Чтобы удалить развертывание и службу, выполните следующие команды для пространства имен.
>
> ```azurecli
> kubectl delete deployment routingmanager-deployment -n NAMESPACE
> kubectl delete service routingmanager-service -n NAMESPACE
> ```

## <a name="diagnostics-and-logging"></a>Диагностика и ведение журнала

При использовании Bridge to Kubernetes для подключения к кластеру журналы диагностики из кластера записываются в каталог *TEMP* в папке *Bridge to Kubernetes* на компьютере разработки.

## <a name="rbac-authorization"></a>Авторизация RBAC

Kubernetes предоставляет управление доступом на основе ролей (RBAC) для управления разрешениями пользователей и групп. Дополнительные сведения см. в [документации Kubernetes](https://kubernetes.io/docs/reference/access-authn-authz/rbac/). Вы можете настроить разрешения для кластера с поддержкой RBAC, создав YAML-файл и используя `kubectl` для его применения на кластере. 

Чтобы задать разрешения на кластере, создайте или измените YAML-файл, например приведенный ниже *permissions.yml*, используя собственное пространство имен вместо `<namespace>` и субъекты (пользователи и группы), которым требуется доступ.

```yml
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: bridgetokubernetes-<namespace>
  namespace: development
subjects:
  - kind: User
    name: jane.w6wn8.k8s.ginger.eu-central-1.aws.gigantic.io
    apiGroup: rbac.authorization.k8s.io
  - kind: Group
    name: dev-admin
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: admin
  apiGroup: rbac.authorization.k8s.io
```

Примените разрешения с помощью команды:

```cmd
kubectl -n <namespace> apply -f <yaml file name>
```

## <a name="limitations"></a>Ограничения

Bridge to Kubernetes имеет следующие ограничения:

* Для подключения к службе она должна быть основана на одном модуле pod. Нельзя подключиться к службе с несколькими модулями pod, например службе с репликами.
* Для успешного подключения с помощью функции Bridge to Kubernetes в модуле pod должен выполняться только один контейнер. Функция Bridge to Kubernetes не может подключаться к службам с модулями pod, имеющими дополнительные контейнеры, например контейнеры расширения, внедренные сетками служб.
* В настоящее время модули pod для функции Bridge to Kubernetes должны быть контейнерами Linux. Контейнеры Windows не поддерживаются.
* Изоляцию нельзя применять с протоколом HTTPS, если используется Bridge to Kubernetes с Visual Studio. Протокол HTTPS поддерживается в режиме изоляции только при использовании Visual Studio Code.
* Функции Bridge to Kubernetes требуется повышенный уровень разрешений на компьютере разработки для изменения файла hosts.
* Bridge to Kubernetes нельзя использовать в кластерах с включенной службой Azure Dev Spaces.

### <a name="bridge-to-kubernetes-and-clusters-with-azure-dev-spaces-enabled"></a>Bridge to Kubernetes и кластеры с включенной службой Azure Dev Spaces

Нельзя использовать Bridge to Kubernetes в кластерах с включенной службой Azure Dev Spaces. Если вы хотите использовать Bridge to Kubernetes в кластере с включенной службой Azure Dev Spaces, необходимо отключить Azure Dev Spaces перед подключением к кластеру.

## <a name="next-steps"></a>Дальнейшие действия

Чтобы приступить к использованию функции Bridge to Kubernetes для подключения локального компьютера разработки к кластеру, обратитесь к статье [Использование Bridge to Kubernetes](bridge-to-kubernetes.md).

[asp-net-header]: https://www.nuget.org/packages/Microsoft.AspNetCore.HeaderPropagation/
[azds-cli]: /azure/dev-spaces/how-to/install-dev-spaces#install-the-client-side-tools
[azds-tmp-dir]: /azure/dev-spaces/troubleshooting#before-you-begin
[azure-cli]: /cli/azure/install-azure-cli?view=azure-cli-latest&preserve-view=true
[bridge-to-kubernetes-vs]: bridge-to-kubernetes.md
[kubectl-port-forward]: https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#port-forward
[visual-studio]: https://visualstudio.microsoft.com/downloads/
[btk-extension]: https://marketplace.visualstudio.com/items?itemName=ms-azuretools.mindaro
[using-config-yaml]: configure-bridge-to-kubernetes.md