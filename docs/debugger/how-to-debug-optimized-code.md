---
title: Отладка оптимизированного кода | Документация Майкрософт
description: Если это возможно, не создавайте целевой объект выпуска Win32 до отладки программы, поскольку оптимизация может усложнить отладку. См. сведения в этой статье.
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: how-to
f1_keywords:
- vs.debug
dev_langs:
- CSharp
- VB
- FSharp
- C++
helpviewer_keywords:
- breakpoints, in optimized code
- debugging [C++], optimized code
- optimization, debug builds
- debug builds, optimizing
- optimized code, debugging
ms.assetid: fc8eeeb8-6629-4c9b-99f7-2016aee81dff
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: 19b09831aea0f7e38c7d095c1e549496569405c9
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99899297"
---
# <a name="how-to-debug-optimized-code"></a>Практическое руководство. отладку оптимизированного кода

> [!NOTE]
> Отображаемые диалоговые окна и команды меню могут отличаться от описанных в справке в зависимости от текущих параметров или выпуска. Чтобы изменить параметры, в меню "Сервис" выберите команду "Импорт и экспорт параметров". Дополнительные сведения см. в разделе [Сброс параметров](../ide/environment-settings.md#reset-settings).

> [!NOTE]
> Параметр компилятора [/Zo, позволяющий улучшить оптимизированный процесс отладки](/cpp/build/reference/zo-enhance-optimized-debugging) и впервые появившийся в Visual Studio с обновлением 3, генерирует расширенные сведения по отладке для оптимизированного кода (проекты, которые не были собраны с параметром компилятора **/Od**). Дополнительные сведения см. в разделе [Параметры /O (оптимизация кода)](/cpp/build/reference/o-options-optimize-code). Это обеспечивает улучшенную поддержку отладки локальных переменных и встроенных функций.
>
> Когда используется параметр компилятора **/Zo**, режим [Изменить и продолжить](../debugger/edit-and-continue-visual-csharp.md) отключается.

 Когда компилятор оптимизирует код, он перераспределяет и реорганизует инструкции. Это приводит к повышению эффективности скомпилированного кода. В связи с этим перераспределением отладчик не всегда может идентифицировать исходный код, соответствующий набору инструкций.

 Оптимизация может повлиять на:

- Локальные переменные (могут быть удалены оптимизатором или перемещены в места, недоступные для отладки).

- Код внутри функций (изменяется расположение при слиянии оптимизатором блоков кода).

- Имена функций в фреймах стека вызовов (могут оказаться некорректными при слиянии оптимизатором двух функций).

  Фреймы в стеке вызовов почти всегда верные, но при условии наличия символов для всех фреймов. Фреймы в стеке вызовов могут оказаться некорректными при повреждении стека, при наличии функций на ассемблере, или в фреймах операционной системы при отсутствии соответствующих символов в стеке вызовов.

  Глобальные и статические переменные всегда отображаются правильно. Это же относится к структурным типам. Если существует указатель на структуру и его значение правильно, каждая переменная-элемент структуры имеет правильное значение.

  В связи с этими ограничениями следует по возможности отлаживать неоптимизированные версии программы. По умолчанию оптимизация отключена в конфигурации отладки программы C++ и включена в конфигурации выпуска.

  Тем не менее, ошибка может появиться только в оптимизированной версии программы. В этом случае отлаживать нужно как раз оптимизированный код.

## <a name="to-turn-on-optimization-in-a-debug-build-configuration"></a>Включение оптимизации в конфигурации построения отладки

1. При создании нового проекта выберите в качестве конечного продукта `Win32 Debug`. Используйте `Win32 Debug`, пока программа не будет полностью отлажена и готова к созданию сборки `Win32 Release`. Компилятор не оптимизирует `Win32 Debug`.

2. Выберите проект в обозревателе решений.

3. В меню **Вид** выберите команду **Страницы свойств**.

4. В диалоговом окне **Страницы свойств** убедитесь, что в раскрывающемся списке `Debug`Конфигурация **выбран пункт**.

5. В окне папок слева выберите папку **C/C++** .

6. В папке **C++** выберите элемент `Optimization`.

7. В списке свойств справа найдите `Optimization`. Параметр этого свойства скорее всего будет `Disabled (`[/Od](/cpp/build/reference/od-disable-debug)`)`. Выберите один из параметров (`Minimum Size``(`[/O1](/cpp/build/reference/o1-o2-minimize-size-maximize-speed)`)`, `Maximum Speed``(`[/O2](/cpp/build/reference/o1-o2-minimize-size-maximize-speed)`)`, `Full Optimization``(`[/Ox](/cpp/build/reference/ox-full-optimization)`)` или `Custom`).

8. Если для свойства `Custom` выбран параметр `Optimization`, это означает, что можно устанавливать параметры для любого из остальных свойств, показанных в списке.

9. Выберите "Свойства конфигурации", "C/C++", узел "Командная строка" страницы свойств проекта и добавьте `(`[/Zo](/cpp/build/reference/zo-enhance-optimized-debugging)`)` в текстовое поле **Дополнительные параметры**.

    > [!WARNING]
    > Для использования `/Zo` требуется Visual Studio 2013 с обновлением 3 или более поздняя версия.
    >
    >  Добавление параметра `/Zo` приведет к отключению режима [Изменить и продолжить](../debugger/edit-and-continue-visual-csharp.md).

   При отладке оптимизированного кода перейдите в окно **Дизассемблированный код**, чтобы просмотреть, какие инструкции в действительности создаются и выполняются. При задании точек останова следует знать, что они могут двигаться вместе с инструкцией. Рассмотрим следующий пример кода:

```cpp
for (x=0; x<10; x++)
```

 Допустим, точка останова установлена на этой строке. Можно ожидать, что точка останова будет пройдена 10 раз. Но если код оптимизирован, она будет пройдена всего один раз. Это связано с тем, что первая инструкция задает для `x` значение 0. Компилятор распознает, что конкретная инструкция должна быть выполнена один раз, и убирает ее из цикла. Точка останова перемещается вместе с ней. Инструкции, которые сравнивают и увеличивают `x`, остаются внутри цикла. При просмотре окна **Дизассемблированный код** для лучшего контроля [размер шага](/previous-versions/visualstudio/visual-studio-2010/ek13f001(v=vs.100)) автоматически равен одной инструкции, что бывает полезно при пошаговом прохождении оптимизированного кода.

## <a name="see-also"></a>См. также

- [Безопасность отладчика](../debugger/debugger-security.md)
- [Отладка машинного кода](../debugger/debugging-native-code.md)