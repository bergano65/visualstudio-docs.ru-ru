---
title: Практическое руководство. Инструментирование собственной службы и сбор подробных данных об использовании времени с помощью командной строки профилировщика | Документация Майкрософт
ms.date: 11/15/2016
ms.prod: visual-studio-dev14
ms.technology: vs-ide-debug
ms.topic: conceptual
ms.assetid: dfe58b39-63f8-4a87-ab3a-2b5b14faa8d0
caps.latest.revision: 27
author: MikeJo5000
ms.author: mikejo
manager: jillfra
ms.openlocfilehash: 51a7aed986eb031ab6493c9c38939d782d2864ad
ms.sourcegitcommit: 1fc6ee928733e61a1f42782f832ead9f7946d00c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/22/2019
ms.locfileid: "60092881"
---
# <a name="how-to-instrument-a-native-service-and-collect-detailed-timing-data-by-using-the-profiler-command-line"></a>Практическое руководство. Инструментирование собственной службы и Сбор подробных данных о времени с помощью командной строки Profiler
[!INCLUDE[vs2017banner](../includes/vs2017banner.md)]

Эта статья описывает использование программ командной строки для Средств профилирования [!INCLUDE[vsprvs](../includes/vsprvs-md.md)] с целью инструментирования собственной (C/C++) службы, а также для сбора подробных данных по использованию времени.  

> [!NOTE]
>  Вы не можете профилировать службу с помощью метода инструментирования, если ее невозможно перезапустить после запуска компьютера, например, если она запускается только при запуске операционной системы.  
>   
>  Программы командной строки средств профилирования расположены в подкаталоге \Team Tools\Performance Tools каталога установки [!INCLUDE[vs_current_short](../includes/vs-current-short-md.md)]. На 64-разрядных компьютерах доступны 64- и 32-разрядные версии этих программ. Для использования программ командной строки профилировщика необходимо добавить путь к программам в переменную среды PATH окна командной строки или в саму команду. Дополнительные сведения см. в статье [Указание пути к средствам командной строки](../profiling/specifying-the-path-to-profiling-tools-command-line-tools.md).  

 Чтобы собрать подробные данные по использованию времени из собственной службы с помощью метода инструментирования, воспользуйтесь программой [VSInstr.exe](../profiling/vsinstr.md) для создания инструментированной версии компонента. Затем замените неинструментированную версию службы инструментированной, убедившись, что служба настроена для запуска вручную. Затем запустите профилировщик.  

 При запуске службы данные по времени автоматически сохраняются в файл данных. Вы можете приостановить и возобновить сбор данных в ходе сеанса профилирования.  

 Чтобы завершить сеанс профилирования, отключите службу и явным образом завершите работу профилировщика.  

## <a name="starting-the-application-with-the-profiler"></a>Запуск приложения с помощью профилировщика  

#### <a name="to-start-profiling-a-native-service"></a>Запуск профилирования собственной службы  

1. Откройте окно командной строки.  

2. Используйте средство **VSInstr**, чтобы создать инструментированную версию двоичного файла службы.  

3. Замените исходный двоичный файл инструментированной версией. В диспетчере служб Windows убедитесь, что для службы установлен тип запуска "Вручную".  

4. Запуск профилировщика. Тип:  

    **VSPerfCmd** [/start](../profiling/start.md) **:trace**  [/output](../profiling/output.md) **:** `OutputFile` [`Options`]  

   - Параметр **/start:trace** инициализирует профилировщик.  

   - Параметр **/output**`OutputFile` является обязательным при использовании параметра **/start**. `OutputFile` указывает имя и расположение файла данных профилирования (VSP-файла).  

     С параметром **/start:trace** можно использовать любой из следующих параметров.  

   > [!NOTE]
   >  Параметры **/user** и **/crosssession** обычно являются обязательными для приложений ASP.NET.  

   |                                 Параметр                                  |                                                                                                                                                   Описание                                                                                                                                                    |
   |-------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | [/user](../profiling/user-vsperfcmd.md) **:**[`Domain`**\\**]`UserName` |               Указывает домен и имя пользователя учетной записи, которая является владельцем рабочего процесса ASP.NET. Этот параметр является обязательным, если процесс выполняется от имени пользователя, отличного от вошедшего в систему. Владелец процесса указан в столбце "Имя пользователя" на вкладке "Процессы" диспетчера задач Windows.               |
   |              [/crossession](../profiling/crosssession.md)              | Включает профилирование процессов в других сеансах входа. Этот параметр является обязательным, если приложение ASP.NET выполняется в другом сеансе. Идентификатор сеанса указан в столбце "Идентификатор сеанса" на вкладке "Процессы" диспетчера задач Windows. **/CS** можно указать как краткую версию **/crosssession**. |
   |        [/waitstart](../profiling/waitstart.md)[**:**`Interval`]         |                                                 Задает интервал ожидания инициализации профилировщика до возвращения ошибки (в секундах). Если значение `Interval` не указано, профилировщик ожидает в течение неограниченного срока. По умолчанию параметр **/start** возвращает ошибку немедленно.                                                  |
   |          [/globaloff](../profiling/globalon-and-globaloff.md)           |                                                                             Для запуска профилировщика с приостановкой сбора данных добавьте параметр **/globaloff** в командную строку **/start**. Используйте параметр **/globalon** для возобновления профилирования.                                                                              |
   |           [/counter](../profiling/counter.md) **:** `Config`            |                                                                           Собирает данные из счетчика производительности процессора, указанного в файле конфигурации. Сведения счетчика добавляются в данные, собранные для каждого события профилирования.                                                                           |
   |    [/wincounter](../profiling/wincounter.md) **:** `WinCounterPath`     |                                                                                                                    Задает счетчик производительности Windows, данные которого будут собираться во время профилирования.                                                                                                                     |
   |         [/automark](../profiling/automark.md) **:** `Interval`          |                                                                                  Используется с только с параметром **/wincounter**. Указывает время (в миллисекундах) между событиями сбора счетчика производительности Windows. Значение по умолчанию — 500 мс.                                                                                   |
   |       [/events](../profiling/events-vsperfcmd.md) **:** `Config`        |                                                                                     Задает события трассировки событий для Windows (ETW), собираемые во время профилирования. События трассировки событий Windows собираются в отдельный ETL-файл.                                                                                     |

5. Запустите службу из диспетчера служб.  

## <a name="controlling-data-collection"></a>Управление сбором данных  
 Пока служба запущена, с помощью параметров программы **VSPerfCmd.exe** можно начинать и останавливать запись в файл данных профилировщика. Управление сбором данных позволяет собирать данные на конкретных этапах выполнения программы, например при запуске или завершении работы службы.  

#### <a name="to-start-and-stop-data-collection"></a>Запуск и остановка сбора данных  

- Следующие пары параметров **VSPerfCmd** запускают и останавливают сбор данных. Каждый параметр необходимо указывать в отдельной командной строке. Сбор данных можно включать и отключать несколько раз.  

    |Параметр|Описание|  
    |------------|-----------------|  
    |[/globalon /globaloff](../profiling/globalon-and-globaloff.md)|Запускает (**/globalon**) или останавливает (**/globaloff**) сбор данных для всех процессов.|  
    |[/processon](../profiling/processon-and-processoff.md) **:** `PID` [/processoff](../profiling/processon-and-processoff.md) **:** `PID`|Запускает (**/processon**) или останавливает (**/processoff**) сбор данных для процесса с указанным идентификатором процесса (`PID`).|  
    |[/threadon](../profiling/threadon-and-threadoff.md) **:** `TID` [/threadoff](../profiling/threadon-and-threadoff.md) **:** `TID`|Запускает (**/threadon**) или останавливает (**/threadoff**) сбор данных для потока с указанным идентификатором потока (`TID`).|  

## <a name="ending-the-profiling-session"></a>Завершение сеанса профилирования  
 Для завершения сеанса профилирования остановите службу, в которой выполняется инструментированный компонент, а затем вызовите параметр **VSPerfCmd**[/shutdown](../profiling/shutdown.md), чтобы выключить профилировщик и закрыть файл данных профилирования.  

#### <a name="to-end-a-profiling-session"></a>Завершение сеанса профилирования  

1. Остановите службу из диспетчера служб.  

2. Завершите работу профилировщика. Тип:  

     **VSPerfCmd /shutdown**  

3. Замените инструментированный модуль исходным. При необходимости измените тип запуска службы.  

## <a name="see-also"></a>См. также  
 [Службы профилирования](../profiling/command-line-profiling-of-services.md)   
 [Представление данных метода инструментирования](../profiling/instrumentation-method-data-views.md)
