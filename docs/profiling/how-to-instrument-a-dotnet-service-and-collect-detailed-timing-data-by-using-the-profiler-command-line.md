---
title: Практическое руководство. Инструментирование службы .NET и сбор подробных данных об использовании времени с помощью командной строки профилировщика | Документы Майкрософт
ms.custom: ''
ms.date: 11/04/2016
ms.technology: vs-ide-debug
ms.topic: conceptual
author: mikejo5000
ms.author: mikejo
manager: douge
ms.workload:
- dotnet
ms.openlocfilehash: c7a5cbb2f411a6d1e2c01275e07da1ea7321488b
ms.sourcegitcommit: 1b9c1e333c2f096d35cfc77e846116f8e5054557
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/06/2018
ms.locfileid: "34815968"
---
# <a name="how-to-instrument-a-net-service-and-collect-detailed-timing-data-by-using-the-profiler-command-line"></a>Практическое руководство. Инструментирование службы .NET и сбор подробных данных об использовании времени с помощью командной строки профилировщика

В этой статье описано, как использовать программы командной строки для Средств профилирования Visual Studio для инструментирования службы [!INCLUDE[dnprdnshort](../code-quality/includes/dnprdnshort_md.md)] и сбора подробных сведений о времени.

> [!NOTE]
> Вы не можете профилировать службу с помощью метода инструментирования, если ее невозможно перезапустить после запуска компьютера, например, если она запускается только при запуске операционной системы.
>
> Программы командной строки средств профилирования расположены в подкаталоге *\Team Tools\Performance Tools* каталога установки [!INCLUDE[vs_current_short](../code-quality/includes/vs_current_short_md.md)]. На 64-разрядных компьютерах доступны 64- и 32-разрядные версии этих программ. Для использования средств командной строки профилировщика необходимо добавить путь к этим средствам в переменную среды PATH окна командной строки или указать этот путь при вызове команды. Дополнительные сведения см. в статье [Указание пути к программам командной строки средств профилирования](../profiling/specifying-the-path-to-profiling-tools-command-line-tools.md).
>
> Добавление данных об уровневом взаимодействии в сеанс профилирования требует определенных процедур со средствами профилирования командной строки. См. [Сбор данных взаимодействия уровней](../profiling/adding-tier-interaction-data-from-the-command-line.md).

Чтобы собрать подробные данные по использованию времени из службы [!INCLUDE[dnprdnshort](../code-quality/includes/dnprdnshort_md.md)] с помощью метода инструментирования, воспользуйтесь программой [VSInstr.exe](../profiling/vsinstr.md) для создания инструментированной версии компонента. Затем замените неинструментированную версию службы инструментированной, убедившись, что служба настроена для запуска вручную. Далее воспользуйтесь программой [VSPerfCLREnv.cmd](../profiling/vsperfclrenv.md) для инициализации глобальных переменных среды профилирования и перезагрузите компьютер. Затем запустите профилировщик.

При запуске службы данные по времени автоматически сохраняются в файл данных. Вы можете приостановить и возобновить сбор данных в ходе сеанса профилирования.

Чтобы завершить сеанс профилирования, отключите службу и явным образом завершите работу профилировщика. В большинстве случаев рекомендуется сбрасывать переменные среды профилирования в конце сеанса.

## <a name="start-the-application-with-the-profiler"></a>Запуск приложения с помощью профилировщика

1. Откройте окно командной строки.

2. Используйте средство **VSInstr**, чтобы создать инструментированную версию двоичного файла службы.

3. Замените исходный двоичный файл инструментированной версией. В диспетчере служб Windows убедитесь, что для службы установлен тип запуска "Вручную".

4. Инициализируйте переменные среды профилирования [!INCLUDE[dnprdnshort](../code-quality/includes/dnprdnshort_md.md)]. Тип:

     **VSPerfClrEnv /globaltraceon**

5. Перезагрузите компьютер.

6. Откройте окно командной строки.

7. Запуск профилировщика. Тип:

     **VSPerfCmd /start:trace /output:** `OutputFile` [`Options`]

    - Параметр [/start](../profiling/start.md)**:trace** инициализирует профилировщик.

    - Параметр [/output](../profiling/output.md)**:**`OutputFile` является обязательным для параметра **/start**. `OutputFile` указывает имя и расположение файла данных профилирования (*VSP*-файла).

     С параметром **/start:trace** можно использовать любой из следующих параметров.

    > [!NOTE]
    > Параметры **/user** и **/crosssession** обычно являются обязательными для служб профилирования.

    |Параметр|Описание:|
    |------------|-----------------|
    |[/user](../profiling/user-vsperfcmd.md) **:**[`Domain`**\\**]`UserName`|Указывает домен и имя пользователя учетной записи, которая является владельцем профилируемого процесса. Этот параметр является обязательным только в том случае, если процесс выполняется в качестве пользователя, отличного от пользователя, вошедшего в систему. Владелец процесса указан в столбце **Имя пользователя** на вкладке **Процессы** диспетчера задач Windows.|
    |[/crossession](../profiling/crosssession.md)|Включает профилирование процессов в других сеансах. Этот параметр является обязательным, если приложение выполняется в другом сеансе. Идентификатор сеанса указан в столбце **Идентификатор сеанса** на вкладке **Процессы** диспетчера задач Windows. **/CS** можно указать как краткую версию **/crosssession**.|
    |[/waitstart](../profiling/waitstart.md)[**:**`Interval`]|Задает интервал ожидания инициализации профилировщика до возвращения ошибки (в секундах). Если значение `Interval` не указано, профилировщик ожидает в течение неограниченного срока. По умолчанию параметр **/start** возвращает ошибку немедленно.|
    |[/globaloff](../profiling/globalon-and-globaloff.md)|Для запуска профилировщика с приостановкой сбора данных добавьте параметр **/globaloff** в командную строку **/start**. Используйте параметр **/globalon** для возобновления профилирования.|
    |[/counter](../profiling/counter.md) **:** `Config`|Собирает данные из счетчика производительности процессора, указанного в файле конфигурации. Сведения счетчика добавляются в данные, собранные для каждого события профилирования.|
    |[/wincounter](../profiling/wincounter.md) **:** `WinCounterPath`|Задает счетчик производительности Windows, данные которого будут собираться во время профилирования.|
    |[/automark](../profiling/automark.md) **:** `Interval`|Используется с только с параметром **/wincounter**. Указывает время (в миллисекундах) между событиями сбора счетчика производительности Windows. Значение по умолчанию — 500 мс.|
    |[/events](../profiling/events-vsperfcmd.md) **:** `Config`|Задает события трассировки событий для Windows (ETW), собираемые во время профилирования. События трассировки событий Windows собираются в отдельный *ETL*-файл.|

8. Запустите службу из диспетчера служб Windows.

## <a name="control-data-collection"></a>Управление сбором данных

Пока служба запущена, с помощью параметров программы *VSPerfCmd.exe* можно начинать и останавливать запись в файл данных профилировщика. Управление сбором данных позволяет собирать данные на конкретных этапах выполнения программы, например при запуске или завершении работы службы.

- Следующие пары параметров **VSPerfCmd** запускают и останавливают сбор данных. Каждый параметр необходимо указывать в отдельной командной строке. Сбор данных можно включать и отключать несколько раз.

    |Параметр|Описание:|
    |------------|-----------------|
    |[/globalon /globaloff](../profiling/globalon-and-globaloff.md)|Запускает (**/globalon**) или останавливает (**/globaloff**) сбор данных для всех процессов.|
    |[/processon](../profiling/processon-and-processoff.md) **:** `PID` [/processoff](../profiling/processon-and-processoff.md) **:** `PID`|Запускает (**/processon**) или останавливает (**/processoff**) сбор данных для процесса с указанным идентификатором процесса (`PID`).|
    |[/threadon](../profiling/threadon-and-threadoff.md) **:** `TID` [/threadoff](../profiling/threadon-and-threadoff.md) **:** `TID`|Запускает (**/threadon**) или останавливает (**/threadoff**) сбор данных для потока с указанным идентификатором потока (`TID`).|

## <a name="end-the-profiling-session"></a>Завершение сеанса профилирования

Для завершения сеанса профилирования остановите службу, в которой выполняется инструментированный компонент, а затем выполните команду **VSPerfCmd** [/shutdown](../profiling/shutdown.md), чтобы выключить профилировщик и закрыть файл данных профилирования. Команда **VSPerfClrEnv /globaloff** удаляет переменные среды, используемые для профилирования.

Для вступления в силу новых параметров среды необходимо перезагрузить компьютер.

1. Остановите службу из диспетчера служб.

2. Завершите работу профилировщика. Тип:

     **VSPerfCmd /shutdown**

3. После завершения всего профилирования очистите переменные среды профилирования. Тип:

     **VSPerfClrEnv /globaloff**

4. Замените инструментированный модуль исходным. При необходимости измените тип запуска службы.

5. Перезагрузите компьютер.

## <a name="see-also"></a>См. также

[Профилирование служб](../profiling/command-line-profiling-of-services.md)  
[Представления данных метода инструментирования](../profiling/instrumentation-method-data-views.md)
