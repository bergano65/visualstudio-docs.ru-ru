---
title: Практическое руководство. Подключение профилировщика к службе .NET для сбора статистики приложения с помощью командной строки | Документы Майкрософт
ms.custom: ''
ms.date: 11/04/2016
ms.technology: vs-ide-debug
ms.topic: conceptual
ms.assetid: a0046c47-26c8-4bec-96a0-81da05e5104a
author: mikejo5000
ms.author: mikejo
manager: douge
ms.workload:
- dotnet
ms.openlocfilehash: af86168314f8bbe2e3f125e469022b32c9656515
ms.sourcegitcommit: 42ea834b446ac65c679fa1043f853bea5f1c9c95
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/19/2018
---
# <a name="how-to-attach-the-profiler-to-a-net-service-to-collect-application-statistics-by-using-the-command-line"></a>Практическое руководство. Присоединение профилировщика к службе .NET для сбора статистики приложения с помощью командной строки
В этом разделе описано, как с помощью программ командной строки для Средств профилирования [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)] подключить профилировщик к службе .NET Framework и собрать статистику производительности с помощью метода выборки.  
  
> [!NOTE]
>  Возможности расширенной безопасности в Windows 8 и Windows Server 2012 требовали значительных изменений в способе, которым профилировщик Visual Studio собирает данные на этих платформах. Для приложений универсальной платформы Windows также требуются новые методы сбора. См. раздел [Средства производительности в приложениях Windows 8 и Windows Server 2012](../profiling/performance-tools-on-windows-8-and-windows-server-2012-applications.md).  
>   
>  Программы командной строки средств профилирования расположены в подкаталоге \Team Tools\Performance Tools каталога установки [!INCLUDE[vs_current_short](../code-quality/includes/vs_current_short_md.md)]. На 64-разрядных компьютерах доступны 64- и 32-разрядные версии этих программ. Для использования программ командной строки профилировщика необходимо добавить путь к программам в переменную среды PATH окна командной строки или в саму команду. Дополнительные сведения см. в статье [Указание пути к средствам командной строки](../profiling/specifying-the-path-to-profiling-tools-command-line-tools.md).  
>   
>  Добавление данных об уровневом взаимодействии в сеанс профилирования требует определенных процедур со средствами профилирования командной строки. См. раздел [Сбор данных взаимодействия уровней](../profiling/adding-tier-interaction-data-from-the-command-line.md).  
  
 Для сбора данных производительности, полученных от службы .NET Framework, нужно воспользоваться программой [VSPerfCLREnv.cmd](../profiling/vsperfclrenv.md), чтобы инициализировать соответствующие переменные среды. После этого следует перезагрузить компьютер, на котором размещена эта служба, и настроить для него профилирование. Затем профилировщик подключается к процессу службы. Когда профилировщик будет подключен к службе, можно будет приостанавливать и возобновлять сбор данных.  
  
 Чтобы завершить сеанс профилирования, необходимо отключить профилировщик от службы и явным образом завершить его работу. В большинстве случаев рекомендуется сбрасывать переменные среды профилирования в конце сеанса.  
  
## <a name="attaching-the-profiler"></a>Подключение профилировщика  
  
#### <a name="to-attach-the-profiler-to-a-net-framework-service"></a>Подключение профилировщика к службе .NET Framework  
  
1.  Установите службу.  
  
2.  Откройте окно командной строки.  
  
3.  Инициализируйте переменные среды профилирования. Тип:  
  
     **VSPerfClrEnv /globalsampleon** [**/samplelineoff**]  
  
    -   Параметр **/globalsampleon** включает выборку.  
  
    -   Параметр **/samplelineoff** отключает связывание собранных данных с определенными строками исходного кода. Если этот параметр указан, данные назначаются только функциям.  
  
4.  Перезагрузите компьютер.  
  
5.  Откройте окно командной строки.  
  
6.  Запуск профилировщика. Тип:  
  
     **VSPerfCmd**  [/start](../profiling/start.md) **:sample**  [/output](../profiling/output.md) **:** `OutputFile` [`Options`]  
  
    -   Параметр **/start:sample** инициализирует профилировщик.  
  
    -   Параметр **/output**`OutputFile` является обязательным при использовании параметра **/start**. `OutputFile` указывает имя и расположение файла данных профилирования (VSP-файла).  
  
     С параметром **/start:sample** можно использовать любой из следующих параметров.  
  
    > [!NOTE]
    >  Параметры **/user** и **/crosssession** обычно являются обязательными для служб.  
  
    |Параметр|Описание:|  
    |------------|-----------------|  
    |[/user](../profiling/user-vsperfcmd.md) **:**[`Domain`**\\**]`UserName`|Указывает домен и имя пользователя учетной записи, которая является владельцем профилируемого процесса. Этот параметр является обязательным только в том случае, если процесс выполняется в качестве пользователя, отличного от пользователя, вошедшего в систему. Владелец процесса указан в столбце "Имя пользователя" на вкладке "Процессы" диспетчера задач Windows.|  
    |[/crossession](../profiling/crosssession.md)|Включает профилирование процессов в других сеансах. Этот параметр является обязательным, если служба выполняется в другом сеансе. Идентификатор сеанса указан в столбце "Идентификатор сеанса" на вкладке "Процессы" диспетчера задач Windows. **/CS** можно указать как краткую версию **/crosssession**.|  
    |[/wincounter](../profiling/wincounter.md) **:** `WinCounterPath`|Задает счетчик производительности Windows, данные которого будут собираться во время профилирования.|  
    |[/automark](../profiling/automark.md) **:** `Interval`|Используется с только с параметром **/wincounter**. Указывает время (в миллисекундах) между событиями сбора счетчика производительности Windows. Значение по умолчанию — 500 мс.|  
    |[/events](../profiling/events-vsperfcmd.md) **:** `Config`|Задает события трассировки событий для Windows (ETW), собираемые во время профилирования. События трассировки событий Windows собираются в отдельный ETL-файл.|  
  
7.  При необходимости запустите службу.  
  
8.  Подключите профилировщик к службе. Тип:  
  
     **VSPerfCmd**  [/attach](../profiling/attach.md) **:** {`PID`&#124;`ProcName`} [`Sample Event`] [[/targetclr](../profiling/targetclr.md)**:**`Version`]  
  
    -   Указывает идентификатор процесса (`PID`) или имя процесса (ProcName) службы. Просмотреть идентификаторы и имена всех запущенных процессов можно в диспетчере задач Windows.  
  
     По умолчанию выборка данных производительности выполняется каждые 10 000 000 неостановленных циклов процессора. На процессоре с частотой 1 ГГц это приблизительно 100 выборок в секунду. Можно указать один из следующих параметров, чтобы изменить длительность цикла или задать другое событие выборки.  
  
    |Событие выборки|Описание:|  
    |------------------|-----------------|  
    |[/timer](../profiling/timer.md) **:** `Interval`|Изменяет интервал выборки на число циклов тактовой частоты без остановок, указанное в параметре `Interval`.|  
    |[/pf](../profiling/pf.md)[**:**`Interval`]|Изменяет событие выборки на "ошибки страниц". Если указано свойство `Interval`, задает количество ошибок страниц между выборками. Значение по умолчанию — 10.|  
    |[/sys](../profiling/sys-vsperfcmd.md)[`:``Interval`]|Изменяет событие выборки на "системные вызовы" из процесса к ядру операционной системы (syscall). Если указано свойство `Interval`, задает количество вызовов между выборками. Значение по умолчанию — 10.|  
    |[/counter](../profiling/counter.md) **:** `Config`|Изменяет событие выборки, интервал для счетчика производительности процессора и интервал, указанный в параметре `Config`.|  
  
    -   **targetclr:** `Version` указывает версию профилируемой среды CLR, если в приложении загружено несколько версий среды выполнения. Необязательный.  
  
## <a name="controlling-data-collection"></a>Управление сбором данных  
 Пока служба запущена, с помощью параметров программы **VSPerfCmd.exe** можно начинать и останавливать запись в файл данных профилировщика. Управление сбором данных позволяет собирать данные на конкретных этапах выполнения программы, например при запуске или завершении работы приложения.  
  
#### <a name="to-start-and-stop-data-collection"></a>Запуск и остановка сбора данных  
  
-   Следующие пары параметров **VSPerfCmd** запускают и останавливают сбор данных. Каждый параметр необходимо указывать в отдельной командной строке. Сбор данных можно включать и отключать несколько раз.  
  
    |Параметр|Описание:|  
    |------------|-----------------|  
    |[/globalon /globaloff](../profiling/globalon-and-globaloff.md)|Запускает (**/globalon**) или останавливает (**/globaloff**) сбор данных для всех процессов.|  
    |[/processon](../profiling/processon-and-processoff.md) **:** `PID` [/processoff](../profiling/processon-and-processoff.md) **:** `PID`|Запускает (**/processon**) или останавливает (**/processoff**) сбор данных для процесса с указанным идентификатором процесса (`PID`).|  
    |**/attach:**{`PID`&#124;`ProcName`} [/detach](../profiling/detach.md)[:{`PID`&#124;`ProcName`}]|**/attach** запускает сбор данных для процесса с указанным идентификатором или именем процесса. **/detach** останавливает сбор данных для указанного процесса или для всех процессов, если конкретный процесс не задан.|  
  
## <a name="ending-the-profiling-session"></a>Завершение сеанса профилирования  
 Для завершения сеанса профилирования профилировщик необходимо отключить от всех профилируемых процессов, кроме того, необходимо явным образом завершить его работу. Вы можете отключиться от приложения, профилируемого с помощью метода выборки, закрыв приложение или вызвав параметр **VSPerfCmd /detach**. Затем можно вызвать параметр **VSPerfCmd /shutdown**, чтобы завершить работу профилировщика и закрыть файл данных профилирования.  
  
 Команда **VSPerfClrEnv/globaloff** очищает переменные среды профилирования, однако конфигурация системы не сбрасывается до перезагрузки компьютера.  
  
#### <a name="to-end-a-profiling-session"></a>Завершение сеанса профилирования  
  
1.  Чтобы отключить профилировщик от целевого приложения, выполните одно из указанных ниже действий.  
  
    -   Остановите службу.  
  
         - или -  
  
    -   Введите команду **VSPerfCmd /detach**.  
  
2.  Завершите работу профилировщика. Тип:  
  
     **VSPerfCmd /shutdown**  
  
3.  (Необязательно) Сбросьте переменные среды профилирования. Тип:  
  
     **VSPerfClrEnv /globaloff**  
  
4.  Перезагрузите компьютер.  
  
## <a name="see-also"></a>См. также  
 [Службы профилирования](../profiling/command-line-profiling-of-services.md)   
 [Представления данных метода выборки](../profiling/profiler-sampling-method-data-views.md)