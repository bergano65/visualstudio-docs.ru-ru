---
title: Присоединение профилировщика к ASP.NET для получения статистики приложения
description: Сведения о том, как с помощью программ командной строки для средств профилирования Visual Studio подключить профилировщик к веб-приложению ASP.NET и собрать статистику производительности с помощью метода выборки.
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: how-to
ms.assetid: 3725ddbe-ce91-4469-991e-8c5ed048c618
author: mikejo5000
ms.author: mikejo
manager: jmartens
monikerRange: vs-2017
ms.workload:
- aspnet
ms.openlocfilehash: acf625bc5762dbc90265ffc81ab0920ea778f010
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99887982"
---
# <a name="how-to-attach-the-profiler-to-an-aspnet-web-application-to-collect-application-statistics-by-using-the-command-line"></a>Практическое руководство. Присоединение профилировщика к веб-приложению ASP.NET для сбора статистики приложения с помощью командной строки
В этой статье описывается, как с помощью средств профилирования [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)], выполняемых из командной строки, подключить профилировщик к приложению ASP.NET и собрать статистические данные по производительности с использованием метода выборки.

> [!NOTE]
> Возможности расширенной безопасности в Windows 8 и Windows Server 2012 требовали значительных изменений в способе, которым профилировщик Visual Studio собирает данные на этих платформах. Для приложений универсальной платформы Windows также требуются новые методы сбора. См. раздел [Средства производительности в приложениях Windows 8 и Windows Server 2012](../profiling/performance-tools-on-windows-8-and-windows-server-2012-applications.md).
>
> Добавление данных об уровневом взаимодействии в сеанс профилирования требует определенных процедур со средствами профилирования командной строки. См. [Сбор данных взаимодействия уровней](../profiling/adding-tier-interaction-data-from-the-command-line.md).
>
> Сведения о пути к средствам профилирования см. в статье [Указание пути к программам командной строки средств профилирования](../profiling/specifying-the-path-to-profiling-tools-command-line-tools.md). На 64-разрядных компьютерах доступны 64- и 32-разрядные версии этих программ. Для использования программ командной строки профилировщика необходимо добавить путь к программам в переменную среды PATH окна командной строки или в саму команду.

 Для сбора данных по производительности из веб-приложения ASP.NET необходимо инициализировать соответствующие переменные среды и перезапустить компьютер, на котором размещается веб-приложение ASP.NET, чтобы настроить веб-сервер для профилирования.

 После этого необходимо подключить профилировщик к рабочему процессу ASP.NET, в котором размещается веб-сайт. Пока профилировщик подключен к приложению, сбор данных можно приостанавливать и возобновлять.

 Чтобы завершить сеанс профилирования, необходимо отключить профилировщик от профилируемого приложения и явным образом завершить его работу. В большинстве случаев рекомендуется сбрасывать переменные среды профилирования в конце сеанса.

## <a name="start-the-profiler-and-attach-to-an-aspnet-web-application"></a>Запуск профилировщика и подключение к веб-приложению ASP.NET

#### <a name="to-attach-the-profiler-to-an-aspnet-web-application"></a>Подключение профилировщика к веб-приложению ASP.NET

1. Откройте окно командной строки.

2. Инициализируйте переменные среды профилирования. Тип:

    **VSPerfClrEnv /globalsampleon** [**/samplelineoff**]

   - Параметр **/globalsampleon** включает выборку.

   - Параметр **/samplelineoff** отключает связывание собранных данных с определенными строками исходного кода. Если этот параметр указан, данные назначаются только функциям.

3. Перезагрузите компьютер.

4. Запуск профилировщика. Введите:**VSPerfCmd** [/start](../profiling/start.md)**:sample** [/output](../profiling/output.md)**:**`OutputFile`[`Options`]

   - Параметр **/start:sample** инициализирует профилировщик.

   - Параметр **/output**`OutputFile` является обязательным при использовании параметра **/start**. `OutputFile` указывает имя и расположение файла данных профилирования (VSP-файла).

     С параметром **/start:sample** можно использовать любой из приведенных ниже параметров.

   > [!NOTE]
   > Параметры **/user** и **/crosssession** обычно являются обязательными для приложений ASP.NET.

   | Параметр | Описание |
   | - | - |
   | [/user](../profiling/user-vsperfcmd.md) **:**[`Domain`**\\**]`UserName` | Указывает домен и имя пользователя учетной записи, которая является владельцем рабочего процесса ASP.NET. Этот параметр является обязательным, если процесс выполняется от имени пользователя, отличного от пользователя, вошедшего в систему. Владелец процесса указан в столбце **Имя пользователя** на вкладке **Процессы** диспетчера задач Windows. |
   | [/crossession](../profiling/crosssession.md) | Включает профилирование процессов в других сеансах входа. Этот параметр является обязательным, если приложение ASP.NET выполняется в другом сеансе. Идентификатор сеанса указан в столбце "Идентификатор сеанса" на вкладке "Процессы" диспетчера задач Windows. **/CS** можно указать как краткую версию **/crosssession**. |
   | [/wincounter](../profiling/wincounter.md) **:** `WinCounterPath` | Задает счетчик производительности Windows, данные которого будут собираться во время профилирования. |
   | [/automark](../profiling/automark.md) **:** `Interval` | Используется с только с параметром **/wincounter**. Указывает время (в миллисекундах) между событиями сбора счетчика производительности Windows. Значение по умолчанию — 500 мс. |
   | [/events](../profiling/events-vsperfcmd.md) **:** `Config` | Задает события трассировки событий для Windows (ETW), собираемые во время профилирования. События трассировки событий Windows собираются в отдельный ETL-файл. |

5. Запустите веб-приложение ASP.NET обычным образом.

6. Подключите профилировщик к рабочему процессу ASP.NET. Введите:**VSPerfCmd** [/attach](../profiling/attach.md)**:**{`PID`&#124;`ProcName`} [`Sample Event`] [[/targetclr](../profiling/targetclr.md)**:**`Version`]

   - `PID` задает идентификатор рабочего процесса ASP.NET; `ProcName` задает имя рабочего процесса. Просмотреть идентификаторы и имена всех запущенных процессов можно в диспетчере задач Windows.

   - По умолчанию выборка данных производительности выполняется каждые 10 000 000 неостановленных циклов процессора. На процессоре с частотой 1 ГГц это приблизительно 100 раз в секунду. Чтобы изменить длительность цикла тактовой частоты или задать другое событие выборки, можно воспользоваться одним из указанных ниже параметров **VSPerfCmd**.

   |Событие выборки|Описание|
   |------------------|-----------------|
   |[/timer](../profiling/timer.md) **:** `Interval`|Изменяет интервал выборки на число неостановленных циклов, которые указываются с помощью свойства `Interval`.|
   |[/pf](../profiling/pf.md)[**:**`Interval`]|Изменяет событие выборки на "ошибки страниц". Если указано свойство `Interval`, задает количество ошибок страниц между выборками. Значение по умолчанию — 10.|
   |[/sys](../profiling/sys-vsperfcmd.md)[`:``Interval`]|Изменяет событие выборки на "системные вызовы" из процесса к ядру операционной системы (syscall). Если указано свойство `Interval`, задает количество вызовов между выборками. Значение по умолчанию — 10.|
   |[/counter](../profiling/counter.md) **:** `Config`|Изменяет событие выборки и интервал на "счетчик производительности процессора" и интервал, указанный в `Config`.|
   |[/targetclr](../profiling/targetclr.md) **:** `Version`|Указывает версию профилируемой среды CLR, если в приложении загружено несколько версий среды выполнения.|

   - **targetclr:** `Version` задает версию среды CLR для профилирования, если в приложении загружено несколько версий среды выполнения. Необязательный элемент.

## <a name="control-data-collection"></a>Управление сбором данных
 Пока приложение выполняется, вы можете управлять сбором данных путем запуска и остановки записи данных в файл, используя параметры *VSPerfCmd.exe*. Управление сбором данных позволяет собирать данные на конкретных этапах выполнения программы, например при запуске или завершении работы приложения.

#### <a name="to-start-and-stop-data-collection"></a>Запуск и остановка сбора данных

- Следующие пары параметров **VSPerfCmd** запускают и останавливают сбор данных. Каждый параметр необходимо указывать в отдельной командной строке. Сбор данных можно включать и отключать несколько раз.

    |Параметр|Описание|
    |------------|-----------------|
    |[/globalon /globaloff](../profiling/globalon-and-globaloff.md)|Запускает (**/globalon**) или останавливает (**/globaloff**) сбор данных для всех процессов.|
    |[/processon](../profiling/processon-and-processoff.md) **:** `PID` **/processoff:** `PID`|Запускает (**/processon**) или останавливает (**/processoff**) сбор данных для процесса, который указан в `PID`.|
    |[/attach](../profiling/attach.md) **:**{`PID`&#124;`ProcName`} [/detach](../profiling/detach.md)[**:**{`PID`&#124;`ProcName`}]|**/attach** запускает сбор данных для процесса с указанным идентификатором `PID` или именем процесса (ProcName). **/detach** останавливает сбор данных для указанного процесса или для всех процессов, если конкретный процесс не задан.|

## <a name="end-the-profiling-session"></a>Завершение сеанса профилирования
 Для завершения сеанса профилирования закройте веб-приложение [!INCLUDE[vstecasp](../code-quality/includes/vstecasp_md.md)], а затем воспользуйтесь командой **IISReset** служб IIS, чтобы закрыть рабочий процесс [!INCLUDE[vstecasp](../code-quality/includes/vstecasp_md.md)]. Вызовите команду **VSPerfCmd** [/shutdown](../profiling/shutdown.md), чтобы завершить работу профилировщика и закрыть файл данных профилирования.

 Команда **VSPerfClrEnv /globaloff** удаляет переменные среды, используемые для профилирования. Для вступления в силу новых параметров среды необходимо перезагрузить компьютер.

 Команда **VSPerfClrEnv/globaloff** очищает переменные среды профилирования, однако конфигурация системы не сбрасывается до перезагрузки компьютера.

#### <a name="to-end-a-profiling-session"></a>Завершение сеанса профилирования

1. Чтобы отключить профилировщик от целевого приложения, выполните одно из указанных ниже действий.

   - Введите команду **VSPerfCmd /detach**.

      -или-

   - Завершите рабочий процесс [!INCLUDE[vstecasp](../code-quality/includes/vstecasp_md.md)].

2. Завершите работу профилировщика. Введите:**VSPerfCmd** [/shutdown](../profiling/shutdown.md)

3. (Необязательно) Сбросьте переменные среды профилирования. Тип:

    **VSPerfCmd /globaloff**

4. Перезагрузите компьютер.

## <a name="see-also"></a>См. также
- [Профилирование веб-приложений ASP.NET](../profiling/command-line-profiling-of-aspnet-web-applications.md)
- [Представления данных метода выборки](../profiling/profiler-sampling-method-data-views.md)
