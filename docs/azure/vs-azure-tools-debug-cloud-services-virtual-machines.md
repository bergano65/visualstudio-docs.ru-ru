---
title: Отладка облачной службы или виртуальной машины Azure
description: Отладка облачной службы или виртуальной машины в Visual Studio
author: mikejo5000
manager: jmartens
ms.topic: how-to
ms.workload: azure-vs
ms.date: 11/11/2016
ms.author: mikejo
ms.technology: vs-ide-debug
ms.openlocfilehash: c7a95c43435cf78f169ce363b3e8fe301e9d0cbe
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99844337"
---
# <a name="debugging-an-azure-cloud-service-or-virtual-machine-in-visual-studio"></a>Отладка облачной службы или виртуальной машины Azure в Visual Studio

Visual Studio предоставляет разнообразные варианты отладки облачных служб и виртуальных машин Azure.

## <a name="debug-your-cloud-service-on-your-local-computer"></a>Отладка облачной службы на локальном компьютере

Вы можете сэкономить время и деньги, воспользовавшись эмулятором вычислений Azure для отладки облачной службы на локальном компьютере. Посредством локальной отладки службы перед ее развертыванием можно повысить надежность и производительность службы, не платя за время использования вычислительных ресурсов. Однако некоторые ошибки могут возникнуть только при запуске облачной службы непосредственно в среде Azure. Эти ошибки можно устранить, если включить удаленную отладку при публикации службы, а затем подключить отладчик к экземпляру роли.

Эмулятор имитирует службу вычислений Azure и выполняется в локальной среде, благодаря чему можно осуществить тестирование и отладку облачной службы перед ее развертыванием. Эмулятор обрабатывает жизненный цикл экземпляров ролей и предоставляет доступ к имитируемым ресурсам, таким как локальное хранилище. При отладке или запуске службы в системе Visual Studio она автоматически запускает эмулятор в качестве фонового приложения, а затем выполняет развертывание службы в эмуляторе. Вы можете использовать эмулятор для просмотра службы, запущенной в локальной среде. Можно запустить полную версию или экспресс-версию эмулятора. (Начиная с Azure 2,3, используется Экспресс-версия эмулятора по умолчанию.) См. раздел [Использование Emulator Express для локального запуска и отладки облачной службы](vs-azure-tools-emulator-express-debug-run.md).

### <a name="to-debug-your-cloud-service-on-your-local-computer"></a>Порядок отладки облачной службы на локальном компьютере

1. В строке меню выберите **Отладка**  >  **начать отладку** , чтобы запустить проект облачной службы Azure. Также можно просто нажать клавишу F5. Вы увидите сообщение о том, что запускается эмулятор вычислений. На запуск эмулятора указывает значок в области уведомлений.

    ![Эмулятор Azure в области уведомлений](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC783828.png)

2. Откройте пользовательский интерфейс эмулятора вычислений. Для этого в области уведомлений правой кнопкой мыши щелкните значок Azure и выберите пункт **Show Compute Emulator UI** (Показать пользовательский интерфейс эмулятора вычислений).

    В левой области пользовательского интерфейса показаны службы, которые сейчас развернуты в эмуляторе вычислений, и экземпляры ролей, которые выполняет каждая служба. Вы можете выбрать службу или роль для отображения жизненного цикла, журналов и диагностических сведений в области справа. При установке фокуса на верхнее поле вложенного окна оно развертывается, заполняя правую область.

3. Пошаговое применение приложения путем выбора команд в меню **Отладка** и задания точек останова в коде. По мере работы с приложением в отладчике в областях будет отображаться текущее состояние приложения. При остановке отладки развертывание приложения удаляется. Если приложение включает в себя веб-роль и было задано свойство Startup action для запуска веб-браузера, то Visual Studio запускает веб-приложение в браузере. Если вы изменили количество экземпляров роли в конфигурации службы, то необходимо остановить облачную службу и затем перезапустить отладку, чтобы можно было отлаживать эти новые экземпляры роли.

    > [!NOTE]
    > После остановки выполнения или отладки службы локальный эмулятор вычислений и эмулятор хранения не останавливаются. Необходимо остановить их явным образом в области уведомлений.

## <a name="debug-a-cloud-service-in-azure"></a>Отладка облачной службы в Azure

Чтобы выполнить отладку облачной службы с удаленного компьютера, необходимо включить эту функциональную возможность явным образом при развертывании облачной службы, чтобы необходимые службы (например, msvsmon.exe) были установлены на виртуальных машинах, где выполняются ваши  экземпляры ролей. Если вы не включили удаленную отладку при публикации службы, необходимо повторно опубликовать эту службу с включенной удаленной отладкой.

Если вы включили удаленную отладку для облачной службы, это не приводит к снижению производительности и не требует дополнительных затрат. Не используйте удаленную отладку для рабочей службы, так как это может негативно сказаться на работе клиентов, использующих эту службу.

> [!NOTE]
> При публикации облачной службы из Visual Studio для всех ролей в службе, которые используют .NET Framework 4 или .NET Framework 4.5, можно активировать **IntelliTrace**. С помощью **IntelliTrace** можно изучить события, произошедшие в экземпляре роли в прошлом, и воспроизвести контекст за тот период времени. Ознакомьтесь со статьями [Отладка опубликованной облачной службы с помощью IntelliTrace и Visual Studio](vs-azure-tools-IntelliTrace-debug-published-cloud-services.md) и [Использование IntelliTrace](../debugger/intellitrace.md).

### <a name="to-enable-remote-debugging-for-a-cloud-service"></a>Порядок включения удаленной отладки для облачной службы

1. Откройте контекстное меню проекта Azure и выберите пункт **Опубликовать**.

2. Выберите элемент **Промежуточная среда** и конфигурацию **Отладка**.

    Это всего лишь рекомендация. Вы можете запустить тестовую среду в рабочей среде. Однако включение удаленной отладки в рабочей среде может отрицательно сказаться на работе пользователей. Вы можете выбрать конфигурацию выпуска, однако конфигурация отладки облегчает процесс отладки.

    ![Выберите конфигурацию отладки](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746717.gif)

3. Дальше выполните стандартную процедуру, но на вкладке **Дополнительные параметры** установите флажок **Enable Remote Debugger for all roles** (Включить удаленный отладчик для всех ролей).

    ![Конфигурация отладки](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746718.gif)

### <a name="to-attach-the-debugger-to-a-cloud-service-in-azure"></a>Порядок подключения отладчика к облачной службе в Azure

1. В обозревателе серверов разверните узел своей облачной службы.

2. Откройте контекстное меню роли или экземпляра роли, к которому требуется присоединить отладчик, и выберите **Присоединить отладчик**.

    При отладке роли отладчик Visual Studio подключается к каждому ее экземпляру. Отладчик останавливается в точке останова для первого экземпляра роли, который запускает эту строку кода и удовлетворяет условиям этой точки останова. При отладке экземпляра отладчик подключается только к данному экземпляру и останавливается на точке останова только в том случае, если данный конкретный экземпляр запускает эту строку кода и удовлетворяет условиям точки останова.

    ![Присоединить отладчик](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746719.gif)

3. После подключения отладчика к экземпляру выполняйте отладку в обычном режиме. Отладчик автоматически подключается к соответствующему хост-процессу для вашей роли. В зависимости от того, что представляет собой эта роль, отладчик подключается к w3wp.exe, WaWorkerHost.exe или WaIISHost.exe. Чтобы проверить процесс, к которому подключен отладчик, разверните узел экземпляра в обозревателе серверов. Дополнительные сведения о процессах Azure см. в статье [Архитектура ролей Azure](/archive/blogs/kwill/windows-azure-role-architecture).

    ![Диалоговое окно "Выбор типа кода"](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC718346.png)

4. Чтобы найти процессы, к которым присоединен отладчик, в строке меню выберите **Отладка**  >    >  **процессов** Windows и откройте диалоговое окно **процессы** . (Сочетание клавиш: CTRL + ALT + Z) Чтобы отключить определенный процесс, откройте его контекстное меню и выберите пункт **Отсоединить процесс**. Или перейдите к узлу экземпляра в обозревателе сервера, найдите процесс, откройте его контекстное меню и выберите пункт **Отсоединить процесс**.

    ![Отладить процессы](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC690787.gif)

> [!WARNING]
> Во время удаленной отладки избегайте длинных остановок на точках останова. Azure обрабатывает процесс, остановленный дольше, чем на несколько минут, как не отвечающий на запросы, и прекращает направлять трафик в этот экземпляр. В случае остановки на слишком длительный срок msvsmon.exe отключается от процесса.

Чтобы отключить отладчик от всех процессов в экземпляре или роли, откройте контекстное меню роли или экземпляра, для которых выполняется отладка, и выберите пункт **Отсоединить отладчик**.

## <a name="limitations-of-remote-debugging-in-azure"></a>Ограничения удаленной отладки в Azure

Начиная с пакета Azure SDK 2.3, удаленная отладка имеет следующие ограничения:

* При включенной удаленной отладке нельзя опубликовать облачную службу, в которой любая роль содержит более 25 экземпляров.
* Отладчик использует порты 30400–30424, 31400–31424 и 32400–32424. Если вы попытаетесь использовать любой из этих портов, то не сможете опубликовать службу, а в журнале действий для Azure появится одно из следующих сообщений об ошибке:

  * Ошибка проверки CSCFG-файла на основе CSDEF-файла.
    Зарезервированный диапазон портов "диапазон" для конечной точки Microsoft.WindowsAzure.Plugins.RemoteDebugger.Connector роли "роль" перекрывается с уже заданным портом или диапазоном.
  * Ошибка выделения. Повторите попытку позднее. Попытайтесь уменьшить размер ВМ или число экземпляров роли или попробуйте выполнить развертывание в другом регионе.

## <a name="debugging-azure-virtual-machines"></a>Отладка виртуальных машин Azure

Вы можете выполнять отладку программ, выполняемых на виртуальных машинах Azure, с помощью обозревателя серверов в Visual Studio. При включении удаленной отладки на виртуальной машине Azure среда Azure устанавливает в виртуальной машине расширение удаленной отладки. После этого вы можете подключиться к процессам на виртуальной машине и выполнить отладку обычным образом.

> [!NOTE]
> Виртуальные машины, созданные через стек диспетчера ресурсов Azure, можно отлаживать удаленно с помощью Cloud Explorer в Visual Studio 2015. Дополнительные сведения см. в статье [Управление ресурсами Azure с помощью Cloud Explorer](vs-azure-tools-resources-managing-with-cloud-explorer.md).

### <a name="to-debug-an-azure-virtual-machine"></a>Порядок отладки виртуальной машины Azure

1. В обозревателе серверов разверните узел "Виртуальные машины" и выберите узел той виртуальной машины, для которой необходимо выполнить отладку.

2. Откройте контекстное меню и выберите пункт **Включить отладку**. Когда появится запрос о подтверждении включения отладки на виртуальной машине, нажмите кнопку **Да**.

    Azure установит расширение для удаленной отладки на виртуальную машину, что позволит выполнять отладку.

    ![Команда включения отладки в виртуальной машине](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746720.png)

    ![Журнал действий Azure](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746721.png)

3. По окончании установки расширения для удаленной отладки откройте контекстное меню виртуальной машины и выберите пункт **Присоединить отладчик...**

    Azure получит список процессов виртуальной машины и отобразит их в диалоговом окне **Присоединение к процессу**.

    ![Команда подключения отладчика](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746722.png)

4. В диалоговом окне **Присоединение к процессу** нажмите кнопку **Выбрать** и выберите только те типы кода, для которых требуется отладка. Вы можете осуществлять отладку 32-разрядного или 64-разрядного управляемого и/или машинного кода.

    ![Диалоговое окно "Выбор типа кода"](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC718346.png)

5. Выберите процессы, которые требуется отладить на виртуальной машине, а затем нажмите кнопку **присоединить**. Например, можно выбрать процесс w3wp.exe, если требуется выполнить отладку веб-приложения на виртуальной машине. Дополнительные сведения см. в статьях [Отладка одного или нескольких процессов в Visual Studio](../debugger/debug-multiple-processes.md) и [Архитектура ролей Azure](/archive/blogs/kwill/windows-azure-role-architecture).

## <a name="create-a-web-project-and-a-virtual-machine-for-debugging"></a>Создание веб-проекта и виртуальной машины для отладки

Перед публикацией проекта Azure может оказаться удобным протестировать его в автономной среде, которая поддерживает сценарии отладки и тестирования и где можно установить программы для тестирования и мониторинга. Одним из способов запуска таких тестов является удаленная отладка приложения на виртуальной машине.

Проекты Visual Studio ASP.NET позволяют создать удобную виртуальную машину, которую можно использовать для тестирования приложений. Эта виртуальная машина включает в себя часто используемые конечные точки, такие как PowerShell, удаленный рабочий стол и WebDeploy.

### <a name="to-create-a-web-project-and-a-virtual-machine-for-debugging"></a>Порядок создания веб-проекта и виртуальной машины для отладки

1. Создайте в Visual Studio новое веб-приложение ASP.NET.

2. В диалоговом окне Новый проект ASP.NET в разделе Azure выберите **Виртуальная машина** в раскрывающемся списке. Оставьте флажок **Создать удаленные ресурсы** установленным. Нажмите кнопку **ОК** , чтобы продолжить.

    Откроется диалоговое окно **Создание виртуальной машины в Azure**.

    ![Диалоговое окно "Создать веб-проект ASP.NET"](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746723.png)

    > [!NOTE]
    > Если вы еще не выполнили вход, появится запрос на вход в вашу учетную запись Azure.

3. Выберите различные параметры для виртуальной машины и нажмите кнопку **ОК**. Дополнительные сведения см. в статье [Виртуальные машины](/azure/virtual-machines/).

    Имя, которое вы указали в поле DNS-имени, будет использоваться как имя виртуальной машины.

    ![Диалоговое окно "Создать виртуальную машину"](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746724.png)

    Azure создает виртуальную машину, а затем подготавливает и настраивает конечные точки, например удаленный рабочий стол и веб-развертывание.

4. После окончательной настройки виртуальной машины выберите ее узел в обозревателе серверов.

5. Откройте контекстное меню и выберите пункт **Включить отладку**. Когда появится запрос о подтверждении включения отладки на виртуальной машине, нажмите кнопку **Да**.

    Azure устанавливает расширение удаленной отладки в виртуальной машине для включения отладки.

    ![Команда включения отладки в виртуальной машине](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746720.png)

    ![Журнал действий Azure](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746721.png)

6. Опубликуйте проект в соответствии с инструкциями из статьи [Развертывание веб-проекта с помощью публикации одним щелчком в Visual Studio](/previous-versions/aspnet/dd465337(v=vs.110)). Поскольку вы хотите выполнить отладку в виртуальной машине, на странице **Параметры** мастера **публикации веб-сайта** выберите в качестве конфигурации значение **Отладка**. Это позволяет просматривать символы кода во время отладки.

    ![Параметры публикации](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC718349.png)

7. В области **Параметры публикации файлов** выберите значение **Удалить дополнительные файлы в конечном расположении**, если ранее проект уже был развернут.

8. Когда проект опубликуется, в обозревателе сервера в контекстном меню виртуальной машины выберите **Присоединить отладчик...**

    Azure получит список процессов виртуальной машины и отобразит их в диалоговом окне **Присоединение к процессу**.

    ![Команда подключения отладчика](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746722.png)

9. В диалоговом окне **Присоединение к процессу** нажмите кнопку **Выбрать** и выберите только те типы кода, для которых требуется отладка. Вы можете осуществлять отладку 32-разрядного или 64-разрядного управляемого и/или машинного кода.

    ![Диалоговое окно "Выбор типа кода"](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC718346.png)

10. Выберите процессы, которые требуется отладить на виртуальной машине, а затем нажмите кнопку **присоединить**. Например, можно выбрать процесс w3wp.exe, если требуется выполнить отладку веб-приложения на виртуальной машине. Дополнительные сведения см. в статье [Отладка одного или нескольких процессов в Visual Studio](../debugger/debug-multiple-processes.md).

## <a name="next-steps"></a>Дальнейшие действия

* Используйте **IntelliTrace** , чтобы получить журнал вызовов и событий с сервера выпуска. Ознакомьтесь со статьей [Отладка опубликованной облачной службы с помощью IntelliTrace и Visual Studio](vs-azure-tools-IntelliTrace-debug-published-cloud-services.md).

* Используйте **систему диагностики Azure** для регистрации подробных сведений из кода, выполняющегося в ролях, независимо от того, запущены ли эти роли в среде разработки или в Azure. Ознакомьтесь со статьей [Включение системы диагностики Azure в облачных службах Azure](/azure/cloud-services/cloud-services-dotnet-diagnostics).
