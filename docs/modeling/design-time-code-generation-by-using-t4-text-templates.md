---
title: Создание кода во время разработки с помощью текстовых шаблонов T4
description: Узнайте, как текстовые шаблоны T4 во время разработки позволяют создавать программный код и другие файлы в проекте Visual Studio.
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: how-to
helpviewer_keywords:
- text templates, guidelines for code generation
- text templates, data source model
- TextTemplatingFileGenerator custom tool
- Transform All Templates
- text templates, getting started
- Text Template project item
- text templates, generating code for your application
author: JoshuaPartlow
ms.author: joshuapa
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: 11c9384d03971f475abbe680f6731d2757cbb195
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99935304"
---
# <a name="design-time-code-generation-by-using-t4-text-templates"></a>Создание кода во время разработки с помощью текстовых шаблонов T4

Текстовые шаблоны T4 во время разработки позволяют создавать программный код и другие файлы в проекте Visual Studio. Как правило, шаблоны создаются таким образом, что они изменяют код, создаваемый в соответствии с данными из *модели*. Модель — это файл или база данных, содержащая основные сведения о требованиях приложения.

Например, можно создать модель, которая определяет рабочий процесс как таблицу или схему. На основе модели можно создать программу, выполняющую рабочий процесс. При изменении требований пользователей можно легко обсудить новый рабочий процесс с пользователями. Повторное создание кода на основе рабочего процесса надежнее, чем обновление кода вручную.

> [!NOTE]
> *Модель* — это источник данных, описывающий определенный аспект приложения. Она может быть представлена в любой форме, в виде файла или базы данных. Она не должна соответствовать определенной форме, например как модель UML или модель для доменного языка (DSL). Типичные модели создаются в форме таблиц или XML-файлов.

Вероятно, вы уже знакомы с созданием кода. При определении ресурсов в **RESX** -файле в решении Visual Studio набор классов и методов создается автоматически. Файл ресурсов обеспечивает более простое и надежное редактирование ресурсов по сравнению с внесением изменений в классы и методы. Используя текстовые шаблоны, можно создавать код таким же образом на основе вашего собственного источника.

Текстовый шаблон содержит сочетание текста, который требуется создать, и программного кода, создающего переменные части текста. Программный код позволяет повторять или условно опускать части сгенерированного текста. Созданный текст сам по себе может быть программным кодом, который формирует часть вашего приложения.

## <a name="create-a-design-time-t4-text-template"></a>Создание Design-Time текстового шаблона T4

1. Создайте новый проект Visual Studio или откройте существующий.

2. Добавьте в проект файл текстового шаблона и присвойте ему имя с расширением **TT**.

    Для этого в **Обозреватель решений** в контекстном меню проекта выберите **Добавить**  >  **новый элемент**. В диалоговом окне **Добавление нового элемента** выберите **текстовый шаблон** в средней области.

    Обратите внимание, что свойство **Custom Tool** файла — **тексттемплатингфилеженератор**.

3. Откройте файл. Он будет содержать следующие директивы:

   ```
   <#@ template hostspecific="false" language="C#" #>
   <#@ output extension=".txt" #>
   ```

    Если вы добавили шаблон в проект [!INCLUDE[vbprvb](../code-quality/includes/vbprvb_md.md)], для атрибута языка будет задано значение `VB`.

4. Добавьте любой текст в конец файла. Пример:

   ```
   Hello, world!
   ```

5. Сохраните файл.

    Может появиться окно сообщения **системы безопасности** с предложением подтвердить, что вы хотите запустить шаблон. Нажмите кнопку **OK**.

6. В **Обозреватель решений** разверните узел файла шаблона, и вы увидите файл с расширением **txt**. Файл содержит текст, созданный на основе шаблона.

   > [!NOTE]
   > Если проект является Visual Basic проектом, необходимо щелкнуть **Показать все файлы** , чтобы увидеть выходной файл.

### <a name="regenerate-the-code"></a>Повторное создание кода

Шаблон выполняется, создавая дочерний файл, в следующих случаях:

- Измените шаблон, а затем переключитесь на другое окно Visual Studio.

- при сохранении шаблона;

- Выберите **преобразовать все шаблоны** в меню **Сборка** . Это приведет к преобразованию всех шаблонов в решении Visual Studio.

- В **Обозреватель решений** в контекстном меню любого файла выберите пункт **запустить настраиваемый инструмент**. Используйте этот метод для преобразования выбранного набора шаблонов.

Можно также настроить проект Visual Studio таким образом, чтобы шаблоны выполнялись при изменении считываемых ими файлов данных. Дополнительные сведения см. [в разделе Автоматическое повторное создание кода](#Regenerating).

## <a name="generate-variable-text"></a>Создать переменный текст

Текстовые шаблоны позволяют программному коду изменять содержимое созданного файла.

1. Измените содержимое файла `.tt`:

   ```csharp
   <#@ template hostspecific="false" language="C#" #>
   <#@ output extension=".txt" #>
   <#int top = 10;

   for (int i = 0; i<=top; i++)
   { #>
      The square of <#= i #> is <#= i*i #>
   <# } #>
   ```

   ```vb
   <#@ template hostspecific="false" language="VB" #>
   <#@ output extension=".txt" #>
   <#Dim top As Integer = 10

   For i As Integer = 0 To top
   #>
       The square of <#= i #> is <#= i*i #>
   <#
   Next
   #>
   ```

2. Сохраните TT-файл и снова проверьте созданный TXT-файл. В нем перечисляются квадратные корни чисел от 0 до 10.

   Обратите внимание, что операторы заключены в символы `<#...#>`, а отдельные выражения — в символы `<#=...#>`. Дополнительные сведения см. [в разделе Написание текстового шаблона T4](../modeling/writing-a-t4-text-template.md).

   Если вы записываете созданный код в [!INCLUDE[vbprvb](../code-quality/includes/vbprvb_md.md)], директива `template` должна содержать атрибут `language="VB"`. Значение по умолчанию — `"C#"`.

## <a name="debugging-a-design-time-t4-text-template"></a>Отладка текстового шаблона времени разработки T4

Отладка текстового шаблона

- Вставьте строку `debug="true"` в директиву `template`. Пример:

   `<#@ template debug="true" hostspecific="false" language="C#" #>`

- Задайте точки останова в шаблоне таким же образом, как для обычного кода.

- Выберите пункт **Отладка шаблона T4** в контекстном меню файла текстового шаблона в Обозреватель решений.

   Шаблон выполняется и останавливается в точках останова. Вы можете проверить переменные и выполнить код пошагово в обычном режиме.

> [!TIP]
> `debug="true"` создает более точное соответствие созданного кода шаблону текста, добавляя в созданный код дополнительные директивы нумерации строк. Если опустить эту строку, точки останова могут останавливать выполнение в неверном состоянии.
>
> Однако это выражение можно оставить в директиве шаблона, даже если вы не выполняете отладку. Это приведет к незначительному снижению производительности.

## <a name="generating-code-or-resources-for-your-solution"></a>Создание кода или ресурсов для решения

Можно создать различающиеся файлы программ в зависимости от модели. Модель представляет собой источник входных данных, такой как база данных, файл конфигурации, модель UML, модель DSL или другой источник. Обычно в одной модели создается несколько программных файлов. Для этого вы создаете файл шаблона для каждого создаваемого файла программы; для всех шаблонов задается чтение одной модели.

### <a name="to-generate-program-code-or-resources"></a>Создание программного кода или ресурсов

1. Измените директиву output, чтобы создать файл нужного типа, например .CS, .VB, .RESX или .XML.

2. Вставьте код, который создаст нужный вам код решения. Например, если требуется создать три объявления поля Integer в классе, используйте код:

    ```csharp

    <#@ template debug="false" hostspecific="false" language="C#" #>
    <#@ output extension=".cs" #>
    <# var properties = new string [] {"P1", "P2", "P3"}; #>
    // This is generated code:
    class MyGeneratedClass {
    <# // This code runs in the text template:
      foreach (string propertyName in properties)  { #>
      // Generated code:
      private int <#= propertyName #> = 0;
    <# } #>
    }
    ```

    ```vb
    <#@ template debug="false" hostspecific="false" language="VB" #>
    <#@ output extension=".cs" #>
    <# Dim properties = {"P1", "P2", "P3"} #>
    class MyGeneratedClass {
    <#
       For Each propertyName As String In properties
    #>
      private int <#= propertyName #> = 0;
    <#
       Next
    #>
    }

    ```

3. Сохраните файл и проверьте созданный файл, который теперь содержит следующий код:

    ```csharp
    class MyGeneratedClass {
      private int P1 = 0;
      private int P2 = 0;
      private int P3 = 0;
    }
    ```

### <a name="generating-code-and-generated-text"></a>Создающий код и созданный текст

При создании программного кода самое важное — не путать создающий код, который выполняется в шаблоне, и создаваемый код, который становится частью вашего решения. Языки этих двух частей не обязательно должны совпадать.

Предыдущий пример имеет две версии. В одной версии создающий код написан на языке C#. В другой версии создающий код написан на языке Visual Basic. Однако создаваемый ими текст одинаков и является классом C#.

Точно так же можно использовать шаблон [!INCLUDE[csprcs](../data-tools/includes/csprcs_md.md)] для создания кода на любом языке. Созданный текст не обязательно должен быть на определенном языке и вообще может не быть программным кодом.

### <a name="structuring-text-templates"></a>Структура текстовых шаблонов

Как правило, рекомендуется разделять код шаблонов на две части.

- Конфигурация или часть, отвечающая за сбор данных, которая задает значения переменных, но не содержит текстовые блоки. В предыдущем примере эта часть представлена кодом, инициализирующим `properties`.

   Ее иногда называют частью "модели", так как она создает хранимую модель и обычно считывает файл модели.

- Часть, создающая текст, (`foreach(...){...}` в примере), которая использует значения переменных.

   Это разделение необязательно, однако оно упрощает чтение шаблона, делая менее сложной часть, которая включает текст.

## <a name="reading-files-or-other-sources"></a>Чтение файлов или других источников

Чтобы получить доступ к файлу модели или базе данных, код шаблона может использовать сборки, такие как System.XML. Чтобы получить доступ к этим сборкам, необходимо вставить директивы, такие как следующие:

```
<#@ assembly name="System.Xml.dll" #>
<#@ import namespace="System.Xml" #>
<#@ import namespace="System.IO" #>
```

`assembly`Директива делает указанную сборку доступной для кода шаблона так же, как и раздел References в проекте Visual Studio. Ссылку не требуется включать в System.dll, так как она создается автоматически. Директива `import` позволяет использовать типы, не используя полные имена, тем же способом, что и директива `using` в обычном файле программы.

Например, после импорта **System.IO** можно написать:

```csharp

<# var properties = File.ReadLines("C:\\propertyList.txt");#>
...
<# foreach (string propertyName in properties) { #>
...
```

```vb
<# For Each propertyName As String In
             File.ReadLines("C:\\propertyList.txt")
#>
```

### <a name="opening-a-file-with-a-relative-pathname"></a>Открытие файла с относительным путем

Чтобы загрузить файл из расположения, относительного для текстового шаблона, можно использовать `this.Host.ResolvePath()`. Для использования this.Host необходимо задать выражение `hostspecific="true"` в `template`:

```
<#@ template debug="false" hostspecific="true" language="C#" #>
```

Затем можно написать код, например:

```csharp
<# string filename = this.Host.ResolvePath("filename.txt");
  string [] properties = File.ReadLines(filename);
#>
...
<#  foreach (string propertyName in properties { #>
...
```

```vb
<# Dim filename = Me.Host.ResolvePath("propertyList.txt")
   Dim properties = File.ReadLines(filename)
#>
...
<#   For Each propertyName As String In properties
...
#>
```

Кроме того, можно использовать `this.Host.TemplateFile`, определяющий имя текущего файла шаблона.

Тип `this.Host` (в VB, `Me.Host`) — `Microsoft.VisualStudio.TextTemplating.ITextTemplatingEngineHost`.

### <a name="getting-data-from-visual-studio"></a>Получение данных из Visual Studio

Чтобы использовать службы, предоставляемые в Visual Studio, установите `hostSpecific` атрибут и загрузите `EnvDTE` сборку. Импорт `Microsoft.VisualStudio.TextTemplating` , содержащий `GetCOMService()` метод расширения.  Затем можно использовать метод IServiceProvider.GetCOMService() для получения доступа к DTE и другим службам. Пример:

```src
<#@ template hostspecific="true" language="C#" #>
<#@ output extension=".txt" #>
<#@ assembly name="EnvDTE" #>
<#@ import namespace="Microsoft.VisualStudio.TextTemplating" #>
<#
  IServiceProvider serviceProvider = (IServiceProvider)this.Host;
  EnvDTE.DTE dte = (EnvDTE.DTE) serviceProvider.GetCOMService(typeof(EnvDTE.DTE));
#>

Number of projects in this VS solution:  <#= dte.Solution.Projects.Count #>
```

> [!TIP]
> Текстовый шаблон выполняется в собственном домене приложений; доступ к службам предоставляется путем маршалинга. В этих обстоятельствах метод GetCOMService() надежнее, чем GetService().

## <a name="regenerating-the-code-automatically"></a><a name="Regenerating"></a> Автоматическое повторное создание кода

Как правило, несколько файлов в решении Visual Studio создаются с одной входной моделью. Каждый файл создается на основе своего собственного шаблона, но все шаблоны относятся к одной модели.

Если изменяется исходная модель, необходимо перезапустить все шаблоны в решении. Чтобы сделать это вручную, выберите **преобразовать все шаблоны** в меню **Сборка** .

Если вы установили пакет SDK для моделирования Visual Studio, все шаблоны можно преобразовать автоматически при каждом выполнении сборки. Для этого внесите изменения в файл проекта (CSPROJ или VBPROJ) в текстовом редакторе и добавьте следующие строки ближе к концу файла после любых других операторов `<import>`:

> [!NOTE]
> Пакет SDK для преобразования текстовых шаблонов и пакет SDK для моделирования Visual Studio устанавливаются автоматически при установке отдельных компонентов Visual Studio. Дополнительные сведения см. в [этой записи блога](https://devblogs.microsoft.com/devops/the-visual-studio-modeling-sdk-is-now-available-with-visual-studio-2017/).

::: moniker range="vs-2017"

```xml
<Import Project="$(MSBuildExtensionsPath)\Microsoft\VisualStudio\v15.0\TextTemplating\Microsoft.TextTemplating.targets" />
<PropertyGroup>
   <TransformOnBuild>true</TransformOnBuild>
   <!-- Other properties can be inserted here -->
</PropertyGroup>
```

::: moniker-end

::: moniker range=">=vs-2019"

```xml
<Import Project="$(MSBuildExtensionsPath)\Microsoft\VisualStudio\v16.0\TextTemplating\Microsoft.TextTemplating.targets" />
<PropertyGroup>
   <TransformOnBuild>true</TransformOnBuild>
   <!-- Other properties can be inserted here -->
</PropertyGroup>
```

::: moniker-end

Дополнительные сведения см. [в разделе Создание кода в процессе сборки](../modeling/code-generation-in-a-build-process.md).

## <a name="error-reporting"></a>Отчеты об ошибках

Чтобы разместить сообщения об ошибках и предупреждениях в окне ошибок Visual Studio, можно использовать следующие методы:

```
Error("An error message");
Warning("A warning message");
```

## <a name="converting-an-existing-file-to-a-template"></a><a name="Converting"></a> Преобразование существующего файла в шаблон

Полезной возможностью шаблонов является то, что они очень похожи на создаваемые им файлы и включают некоторую часть программного кода. Это предполагает удобный способ создания шаблона. Сначала создайте обычный файл в качестве прототипа, например [!INCLUDE[csprcs](../data-tools/includes/csprcs_md.md)] файл, а затем постепенно попытайтесь ввести код поколения, который изменяет результирующий файл.

### <a name="to-convert-an-existing-file-to-a-design-time-template"></a>Преобразование существующего файла в шаблон времени разработки

1. В проект Visual Studio добавьте файл типа, который требуется создать, например `.cs` `.vb` файл, или `.resx` .

2. Проверьте созданный файл, чтобы убедиться, что он работает.

3. В обозреватель решений измените расширение имени файла на **TT**.

4. Проверьте следующие свойства файла **. TT** :

   | | |
   |-|-|
   | **Пользовательский инструмент =** | **TextTemplatingFileGenerator** |
   | **Действие построения =** | **Нет** |

5. Вставьте следующие строки в начало файла:

   ```
   <#@ template debug="false" hostspecific="false" language="C#" #>
   <#@ output extension=".cs" #>
   ```

    Чтобы написать создающий код шаблона в [!INCLUDE[vbprvb](../code-quality/includes/vbprvb_md.md)], задайте для атрибута `language` значение `"VB"` вместо `"C#"`.

    Задайте для атрибута `extension` значение расширения файла того типа, который требуется создать, например `.cs``.resx` или `.xml`.

6. Сохраните файл.

    Создается дочерний файл с заданным расширением. Его свойства будут правильными для данного типа файла. Например, свойство **действия сборки** для CS-файла будет **компилироваться**.

    Убедитесь, что созданный файл содержит то же содержимое, что и исходный.

7. Определите часть файла, которую требуется изменять. Например часть, которая отображается только при соблюдении определенных условий, или повторяемая часть, или часть, в которой варьируются определенные значения. Вставьте создающий код. Сохраните файл и убедитесь, что дочерний файл создается правильно. Повторите этот шаг.

## <a name="guidelines-for-code-generation"></a>Рекомендации по созданию кода

Ознакомьтесь с [рекомендациями по написанию текстовых шаблонов T4](../modeling/guidelines-for-writing-t4-text-templates.md).

## <a name="next-steps"></a>Дальнейшие действия

|Следующий шаг|Раздел|
|-|-|
|Написание и отладка расширенного текстового шаблона с помощью кода, который использует вспомогательные функции, включенные файлы и внешние данные.|[Написание текстового шаблона T4](../modeling/writing-a-t4-text-template.md)|
|Создание документов на основе шаблонов во время выполнения.|[Создание текста во время выполнения с помощью текстовых шаблонов T4](../modeling/run-time-text-generation-with-t4-text-templates.md)|
|Выполняйте создание текста за пределами Visual Studio.|[Создание файлов с помощью служебной программы TextTransform](../modeling/generating-files-with-the-texttransform-utility.md)|
|Преобразование данных в форме доменного языка.|[Создание кода из доменного языка](../modeling/generating-code-from-a-domain-specific-language.md)|
|Написание процессоров директив для преобразования собственных источников данных.|[Настройка преобразования текста T4](../modeling/customizing-t4-text-transformation.md)|

## <a name="see-also"></a>См. также раздел

- [Рекомендации по написанию текстовых шаблонов T4](../modeling/guidelines-for-writing-t4-text-templates.md)
