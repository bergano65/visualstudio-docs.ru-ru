---
title: Настройка элементов и панели элементов
description: Узнайте, как необходимо определить элементы панели элементов для элементов, которые пользователи должны добавлять в свои модели.
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: how-to
f1_keywords:
- vs.dsltools.dsldesigner.selectiondialog
- vs.dsltools.dsldesigner.selecticondialog
- vs.dsltools.dsldesigner.selectcursordialog
helpviewer_keywords:
- Domain-Specific Language, toolbox
author: JoshuaPartlow
ms.author: joshuapa
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: 40341a0c74b371c4c84429474e58c7d338bb8059
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99935434"
---
# <a name="customizing-tools-and-the-toolbox"></a>Настройка элементов и панели элементов

Для тех элементов, которые пользователи смогут добавлять в свои модели, необходимо определить содержание панели элементов. Панель элементов может содержать два вида средств: средства элемента и средства подключения. В созданном конструкторе пользователь может выбрать средство элемента, чтобы перетащить фигуры на схему, и средство подключения, чтобы протянуть связи между фигурами. В целом средства элемента позволяют пользователям добавлять в модели экземпляры классов доменов, а средства подключения — экземпляры доменных связей.

## <a name="how-the-toolbox-is-defined"></a><a name="ToolboxDef"></a> Как определяется панель элементов
 В Обозревателе DSL разверните узел "Редактор" и узлы под ним. Обычно при этом отрывается иерархия следующего вида:

```
Editor
     Toobox Tabs
        MyDsl          //a tab
           Tools
               ExampleElement      // an element tool
               ExampleRelationship // a connection tool
```

В этой части Обозревателя DSL можно выполнять следующие действия.

- Создавать новые таблицы. Вкладки определяют заголовки разделов в панели элементов.

- Создавать новые средства.

- Копировать и вставлять средства.

- Перемещать средства вверх или вниз по списку.

- Удалять вкладки и средства.

> [!IMPORTANT]
> Чтобы добавить или вставить элементы в Обозреватель DSL, щелкните прародителя нового узла правой кнопкой мыши. Например, чтобы добавить средство, щелкните вкладку правой кнопкой мыши, а не узел **средства** . Чтобы добавить вкладку, щелкните правой кнопкой мыши узел **редактора** .

Свойство **значок панели элементов** каждого инструмента ссылается на файл точечного рисунка 16x16. Эти файлы обычно хранятся в папке **дсл\ресаурцес**

Свойство **Class** инструмента element ссылается на конкретный доменный класс. По умолчанию средство будет создавать экземпляры данного класса. Тем не менее можно написать код, заставляющий средство создавать элементы или группы элементов другого типа.

Свойство " **Построитель** подключений" средства подключения ссылается на построитель подключений, который определяет, к каким типам элементов может подключаться средство, и какие связи он создает между ними. Построители подключений определяются в виде узлов в Обозревателе DSL. Построители подключений создаются автоматически при определении доменных связей, но могут также настраиваться с помощью кода.

#### <a name="to-add-a-tool-to-the-toolbox"></a>Добавление средства в панель элементов

1. Средство элемента обычно создают после создания класса фигуры и его сопоставления с классом домена.

     Средство подключения обычно создают после создания класса соединителя и его сопоставления со ссылочным отношением.

2. В обозревателе DSL разверните узел **Редактор** и узел **вкладки панели элементов** .

     Щелкните правой кнопкой мыши узел вкладки области элементов и выберите пункт **Добавить новый элемент инструмент** или **Добавить новое подключение**.

3. Задайте свойство **значок панели элементов** , чтобы оно ссылалось на точечный рисунок 16x16.

     Если вы хотите определить новый значок, создайте файл точечного рисунка в обозреватель решений в папке **дсл\ресаурцес** Файл должен иметь следующие значения свойств: содержимое **действия сборки**  =  . **Копировать в выходной каталог**  =  Не **копируйте**.

4. **Для инструмента элемента:** Задайте свойство **класса** средства, чтобы оно ссылалось на конкретный доменный класс, сопоставленный с фигурой.

     **Для инструмента соединителя:** Задайте для свойства « **Построитель подключений** » один из элементов, предлагаемых в раскрывающемся списке. Построители подключений автоматически создаются при сопоставлении соединителя с доменной связью. Сразу после создания соединителя, как правило, выбирается соответствующий построитель подключений.

5. Чтобы проверить DSL, нажмите клавишу F5 или CTRL + F5, а затем в экспериментальном экземпляре Visual Studio откройте файл образца модели. На панели элементов должно появиться новое средство. Перетащите его на схему, чтобы проверить, создает ли оно новый элемент.

     Если средство не отображается, закройте экспериментальную Visual Studio. В меню " **Пуск** " Windows выполните **Сброс экспериментального экземпляра Microsoft Visual Studio 2010**. В меню **Построить** выберите пункт **Перестроить решение**. Затем проверьте DSL еще раз.

## <a name="customizing-element-tools"></a><a name="customizing"></a> Настройка инструментов элементов
 По умолчанию средство создает один экземпляр указанного класса, но это можно изменять двумя описанными ниже способами.

- Определить директивы слияния элемента с другими классами, позволив им принимать новые экземпляры этого класса и создавать дополнительные ссылки при создании нового элемента. Например, можно разрешить пользователю оставить комментарий на другой элемент и тем самым создать между ними справочную ссылку.

     Эти настройки также влияют на процесс вставки и перетаскивания элемента.

     Дополнительные сведения см. в разделе [Настройка создания и перемещения элементов](../modeling/customizing-element-creation-and-movement.md).

- Написать код, чтобы настроить средство на возможность создания групп элементов. Средство запускается методами из файла ToolboxHelper.cs, которые можно переопределить. Дополнительные сведения см. в разделе [Создание групп элементов из средства](#groups).

## <a name="creating-groups-of-elements-from-a-tool"></a><a name="groups"></a> Создание групп элементов из средства
 Каждое средство элемента содержит прототип элементов, которые оно должно создавать. По умолчанию, каждое средство элемента создает один элемент, но может также создавать группу объектов, связанных с одним средством. Для этого запустите средство с помощью класса <xref:Microsoft.VisualStudio.Modeling.ElementGroupPrototype>, который содержит связанные элементы.

 Следующий пример взят из DSL, в котором есть тип "Транзистор". Каждый транзистор имеет три именованных контакта. Средство элемента для транзисторов хранит прототип, содержащий четыре элемента модели и три ссылки отношения. Когда пользователь перетаскивает средство на схему, создается экземпляр прототипа, который связывается с корнем модели.

 Этот код переопределяет метод, определенный в **дсл\женератедкоде\тулбоксхелпер.КС**.

 Дополнительные сведения о настройке модели с помощью программного кода см. [в разделе Навигация и обновление модели в программном коде](../modeling/navigating-and-updating-a-model-in-program-code.md).

```
using Microsoft.VisualStudio.Modeling;
using Microsoft.VisualStudio.Modeling.Diagrams;

  public partial class CircuitsToolboxHelper
  {
    /// <summary>
    /// Toolbox initialization, called for each element tool on the toolbox.
    /// This version deals with each Component subtype separately.
    /// </summary>
    /// <param name="store"></param>
    /// <param name="domainClassId">Identifies the domain class this tool should instantiate.</param>
    /// <returns>prototype of the object or group of objects to be created by tool</returns>
    protected override ElementGroupPrototype CreateElementToolPrototype(Store store, Guid domainClassId)
    {
        if (domainClassId == Transistor.DomainClassId)
        {
            Transistor transistor = new Transistor(store);

            transistor.Base = new ComponentTerminal(store);
            transistor.Collector = new ComponentTerminal(store);
            transistor.Emitter = new ComponentTerminal(store);

            transistor.Base.Name = "base";
            transistor.Collector.Name = "collector";
            transistor.Emitter.Name = "emitter";

            // Create an ElementGroup for the Toolbox.
            ElementGroup elementGroup = new ElementGroup(store.DefaultPartition);
            elementGroup.AddGraph(transistor, true);
            // AddGraph includes the embedded parts

            return elementGroup.CreatePrototype();
        }
        else
        {
            return base.CreateElementToolPrototype(store, domainClassId);
}  }    }
```

## <a name="customizing-connection-tools"></a><a name="connections"></a> Настройка средств подключения
 Как правило, средство элемента создается при создании нового класса соединителя. Кроме того, можно переопределить одно средство, разрешив типам и обеих сторон определять тип отношения. Например, можно определить одно средство подключения, которое может создавать как отношения типа "человек — человек", так и отношения типа "человек — город".

 Средства подключения вызывают построители подключения. Используйте построители подключения, чтобы указать, каким образом пользователи могут связывать элементы в сгенерированном конструкторе. Построители подключений указывают элементы, которые могут быть связаны, а также создаваемый между ними тип связи.

 При создании ссылочного отношения между доменными классами автоматически создается построитель подключения, который можно использовать при сопоставлении средства подключения. Дополнительные сведения о создании средств подключения см. [в разделе Настройка панели элементов](../modeling/customizing-tools-and-the-toolbox.md).

 Построитель подключения по умолчанию можно изменить так, чтобы он мог справляться с другим диапазоном исходных и целевых типов, а также создавать различные типы отношений.

 Также, для построителей подключения можно написать пользовательский код, чтобы указать исходные и целевые классы для подключения, определить тип создаваемого подключения, и выполнить другие действия, связанные с созданием подключения.

### <a name="the-structure-of-connection-builders"></a>Структура построителей подключения
 Построители подключений содержат одну или несколько директив подключения связей, которые определяют доменные связи, а также исходные и целевые элементы. Например, в шаблоне решения "поток задач" можно увидеть **комментреференцессубжектсбуилдер** в **обозревателе DSL**. Этот построитель подключений содержит одну директиву Link Connect с именем **комментреференцессубжектс**, которая сопоставлена с доменным отношением **комментреференцессубжектс**. Эта директива подключения связи содержит директиву исходной роли, указывающую на класс домена `Comment`, и директиву целевой роли, указывающую на класс домена `FlowElement`.

### <a name="using-connection-builders-to-restrict-source-and-target-roles"></a>Использование построителей подключений для ограничения ограниченным исходных и целевых ролей
 Построители подключений можно использовать для ограничения вхождения некоторых классов в исходную или в целевую роль определенной доменной связи. Например, у вас есть базовый класс домена, имеющий доменную связь с другим классом домена, но вы не хотите, чтобы все производные этого базового класса получали в этой связи те же самые роли. В решении "поток задач" существует четыре конкретных доменных класса (**StartPoint**, **Endpoint**, **мержебранч** и **Synchronization**), которые наследуют непосредственно от абстрактного класса домена **Фловелемент**, и два конкретных доменных класса (**Task** и **обжектинстате**), которые наследуются от него косвенно. Также существует ссылочная связь **потока** , которая принимает доменные классы **фловелемент** как в исходной роли, так и в целевой роли. Однако экземпляр класса домена **конечной точки** не должен быть источником экземпляра связи **потока** , а экземпляр класса **StartPoint** не должен быть целевым объектом экземпляра связи **Flow** . В построителе подключений **фловбуилдер** имеется директива Link Connect с именем **Flow** , указывающая, какие доменные классы могут играть исходную роль (**Task**, **мержебранч**, **StartPoint** и **Synchronization**) и которые могут играть целевую роль (**мержебранч**, **Конечная точка** и **Синхронизация**).

### <a name="connection-builders-with-multiple-link-connect-directives"></a>Построители подключений с несколькими директивами подключения связи
 К построителю подключений можно добавить несколько директив подключения связи. Это может помочь вам скрыть некоторые сложности модели предметной области от пользователей и обеспечить слишком недостаточное количество **элементов для панели инструментов** . К одному построителю подключений можно добавить директивы подключения связи для нескольких различных отношений домена. При этом доменные связи следует объединять в том случае, если они выполняют примерно одинаковую функцию.

 В решении «поток задач» средство подключения **Flow** используется для отображения экземпляров отношений **потока** и **ObjectFlow** домена. В дополнение к директиве связи **потока** , описанной ранее, в построителе подключений **фловбуилдер** есть две директивы Link Connect с именем **ObjectFlow**. Эти директивы указывают, что экземпляр связи **ObjectFlow** может быть нарисован между экземплярами класса домена **обжектинстате** или из экземпляра **обжектинстате** к экземпляру **задачи**, но не между двумя экземплярами **задачи** или экземпляром **задачи** в экземпляре **обжектинстате**. Однако экземпляр связи **Flow** может быть нарисован между двумя экземплярами **задачи**. При компиляции и запуске решения потока задач можно увидеть, что отрисовка **потока** из экземпляра **Обжектинстате** на экземпляр **задачи** создает экземпляр **ObjectFlow**, но прорисовка **потока** между двумя экземплярами **задачи** создает экземпляр **последовательности**.

### <a name="custom-code-for-connection-builders"></a>Пользовательский код для построителей подключения
 В пользовательском интерфейсе имеются четыре флажка, определяющие различные типы настройки построителей подключений:

- флажок **настраиваемого приема** для директивы исходной или целевой роли

- флажок **Custom Connect** для исходной или целевой директивы Role

- флажок **использовать настраиваемое соединение** для директивы Connect

- **пользовательское** свойство построителя подключений

  Чтобы указать эти настройки, необходимо предоставить определенный программный код. Чтобы узнать, какой код необходимо предоставить, установите один их этих флажков, нажмите кнопку "Преобразовать все шаблоны" и постройте собственное решение. В результате будет получено сообщение об ошибке. Дважды щелкните сообщение об ошибке, чтобы увидеть комментарий с описанием кода, который необходимо добавить.

> [!NOTE]
> Чтобы добавить пользовательский код, создайте определение разделяемого класса в файле кода отдельно от файлов кода, находящихся в папках GeneratedCode. Чтобы не потерять свою работу, не изменяйте созданные файлы кода. Дополнительные сведения см. [в разделе Переопределение и расширение созданных классов](../modeling/overriding-and-extending-the-generated-classes.md).

#### <a name="creating-custom-connection-code"></a>Создание пользовательского кода подключения
 В каждой директиве Link Connect на вкладке **директивы исходной роли** определяются типы, которые можно перетаскивать. Аналогичным образом вкладка **директивы целевых ролей** определяет, какие типы можно перетаскивать. Для каждого типа можно дополнительно указать, следует ли разрешить подключение (для этой директивы Link Connect), задав пользовательский флаг **принятия** , а затем указав дополнительный код.

 Также можно настроить действия, происходящие после выполнения подключения. Например, можно настроить только случай перетаскивания в определенный класс, все случаи, когда приоритетное значение имеет одна директива подключения связи, или весь построитель подключения FlowBuilder. Для каждого из этих вариантов можно установить пользовательские флажки на соответствующем уровне. При преобразовании всех шаблонов и попытке построить решение вы получите сообщения об ошибках с комментариями к созданному коду. В этих комментариях указывается, что необходимо предоставить.

 В примере "Схема компонентов" построитель подключения для доменной связи "Подключение" ограничивает подключения, которые могут быть установлены между портами. На следующей иллюстрации показано, что подключения можно установить только от элементов `OutPort` к элементам `InPort`, но компоненты можно вкладывать друг в друга.

 **Подключение входит в тип OutPort вложенного компонента**

 ![Мастер подключения](../modeling/media/connectionbuilder_3.png)

 В связи с этим необходимо указать, что подключение может идти от вложенного компонента к типу OutPort. Чтобы задать такое подключение, в окне " **сведения о DSL** " в качестве исходной роли и типа **порта** в качестве целевой роли **для типа "** **Пользовательская" используется** параметр "принять", как показано на следующих иллюстрациях.

 **Директива подключения связи в Обозревателе DSL**

 ![Изображение мастера подключения](../modeling/media/connectionbuilder_4a.png)

 **Директива подключения связи в окне "Подробные сведения о DSL"**

 ![Директива Link Connect в окне сведений о DSL](../modeling/media/connectionbuilder_4b.png)

 После этого в класс ConnectionBuilder необходимо предоставить методы:

```
  public partial class ConnectionBuilder
  {
    /// <summary>
    /// OK if this component has children
    /// </summary>
    private static bool CanAcceptInPortAsSource(InPort candidate)
    {
       return candidate.Component.Children.Count > 0;
    }

    /// <summary>
    /// Only if source is on parent of target.
    /// </summary>
    private static bool CanAcceptInPortAndInPortAsSourceAndTarget                (InPort sourceInPort, InPort targetInPort)
    {
      return sourceInPort.Component == targetInPort.Component.Parent;
    }
// And similar for OutPorts...
```

 Дополнительные сведения о настройке модели с помощью программного кода см. [в разделе Навигация и обновление модели в программном коде](../modeling/navigating-and-updating-a-model-in-program-code.md).

 Подобный код можно использовать, например, для того, чтобы запретить пользователям создавать циклы со связями между родительскими и дочерними объектами. Эти ограничения считаются "жесткими" ограничениями, так как пользователи не могут нарушать их в любое время. Вы также можете создать "мягкую" проверку, которую пользователи могут временно обойти, создав недопустимые конфигурации, которые они не могут сохранить.

### <a name="good-practice-in-defining-connection-builders"></a>Рекомендации по определению построителей подключений
 Чтобы создаваемые типы отношений были концептуально связаны, настраивайте только один построитель подключений. В примере с задачей потока (Task Flow) для создания потоков между задачами, а также между задачами и объектами используется один и тот же построитель. В то же время использование одного и того же построителя для создания отношений между комментариями и задачами может создавать путаницу.

 Определяя построитель подключений для нескольких типов отношений, обязательно убедитесь, что он не может сопоставить больше одного типа из одной той же пары исходных и целевых объектов. В противном случае результаты будут непредсказуемы.

 Для применения жестких ограничений используется пользовательский код, но следует определить, должны ли пользователи временно создавать недопустимые подключения. Если такую возможность необходимо предоставить, ограничения можно изменить таким образом, чтобы эти подключения не проверялись до тех пор, пока пользователи не попытаются сохранить изменения.

## <a name="see-also"></a>См. также раздел

- [Настройка создания и перемещения элементов](../modeling/customizing-element-creation-and-movement.md)
- [Настройка функции копирования](../modeling/customizing-copy-behavior.md)
- [Практическое руководство. Добавление обработчика перетаскивания](../modeling/how-to-add-a-drag-and-drop-handler.md)
- [Перемещение по модели и обновление модели в коде программы](../modeling/navigating-and-updating-a-model-in-program-code.md)
- [Примеры схем канала DSL](https://code.msdn.microsoft.com/Visualization-Modeling-SDK-763778e8)
