---
title: Настройка хранилища файлов и XML-сериализации
description: Сведения о XML-файле, созданном или обновленном при сохранении экземпляра или модели доменного языка (DSL) в Visual Studio.
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: how-to
f1_keywords:
- vs.dsltools.dsldesigner.xmlbehavior
helpviewer_keywords:
- Domain-Specific Language, serialization
author: JoshuaPartlow
ms.author: joshuapa
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: 019f77320e9118d5f3d31e647a59c71bb474d204
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99935539"
---
# <a name="customize-file-storage-and-xml-serialization"></a>Настройка хранилища файлов и сериализации XML

Когда пользователь сохраняет экземпляр или *модель* доменного языка (DSL) в Visual Studio, создается или обновляется XML-файл. Файл можно перезагрузить для повторного создания модели в хранилище.

Схему сериализации можно настроить, изменив параметры в разделе **поведение сериализации XML** в обозревателе DSL. При **сериализации XML** для каждого доменного класса, свойства и связи существует узел. Связи находятся в исходных классах. Существуют также узлы, соответствующие классам Shape, соединитель и схема.

Можно также написать программный код для расширенной настройки.

> [!NOTE]
> Если вы хотите сохранить модель в определенном формате, но не нужно перезагружать ее из этой формы, рассмотрите возможность использования текстовых шаблонов для создания выходных данных из модели, а не пользовательской схемы сериализации. Дополнительные сведения см. в разделе [Создание кода на основе языка Domain-Specific](../modeling/generating-code-from-a-domain-specific-language.md).

## <a name="model-and-diagram-files"></a>Файлы модели и схемы

Каждая модель обычно сохраняется в двух файлах:

- Имя файла модели, например **Model1. мидсл**. В нем хранятся элементы модели и связи, а также их свойства. Расширение файла, например **. мидсл** , определяется свойством **fileExtension** узла **редактора** в определении DSL.

- Файл схемы имеет имя, такое как **Model1. мидсл. diagram**. В нем хранятся фигуры, соединители и их позиции, цвета, толщины линий и другие сведения о внешнем виде диаграммы. Если пользователь удаляет файл **диаграммы** , основная информация в модели не теряется. Теряются только макет схемы. При открытии файла модели будут созданы набор фигур и соединителей по умолчанию.

### <a name="to-change-the-file-extension-of-a-dsl"></a>Изменение расширения файла DSL

1. Откройте определение DSL. В обозревателе DSL щелкните узел редактор.

2. В окно свойств измените свойство **fileExtension** . Не включайте начальное значение "." для расширения имени файла.

3. В обозреватель решений измените имена двух файлов шаблонов элементов в **дслпаккаже\прожектитемтемплатес**. Эти файлы имеют имена, которые следуют в следующем формате:

     `myDsl.diagram`

     `myDsl.myDsl`

## <a name="the-default-serialization-scheme"></a>Схема сериализации по умолчанию

Чтобы создать пример для этого раздела, использовалось следующее определение DSL.

![Схема определения DSL &#45; модель дерева семейства](../modeling/media/familyt_person.png)

Этот DSL использовался для создания модели, имеющей следующий вид на экране.

![Обозреватель, панель элементов и схема семейного дерева](../modeling/media/familyt_instance.png)

Эта модель была сохранена и повторно открыта в текстовом редакторе XML:

```xml
<?xml version="1.0" encoding="utf-8"?>
<familyTreeModel xmlns:dm0="http://schemas.microsoft.com/VisualStudio/2008/DslTools/Core" dslVersion="1.0.0.0" Id="f817b728-e920-458e-bb99-98edc469d78f" xmlns="http://schemas.microsoft.com/dsltools/FamilyTree">
  <people>
    <person name="Henry VIII" birthYear="1491" deathYear="1547" age="519">
      <children>
        <personMoniker name="/f817b728-e920-458e-bb99-98edc469d78f/Elizabeth I" />
        <personMoniker name="/f817b728-e920-458e-bb99-98edc469d78f/Mary" />
      </children>
    </person>
    <person name="Elizabeth I" birthYear="1533" deathYear="1603" age="477" />
    <person name="Mary" birthYear="1515" deathYear="1558" age="495" />
  </people>
</familyTreeModel>
```

Обратите внимание на следующие моменты о сериализованной модели:

- Каждый узел XML имеет имя, совпадающее с именем доменного класса, за исключением того, что начальная буква строчная. Например, `familyTreeModel` и `person`.

- Свойства домена, такие как Name и Бирсеар, сериализуются как атрибуты в узлах XML. Опять же, начальный символ имени свойства преобразуется в нижний регистр.

- Каждая связь сериализуется как узел XML, вложенный в конец источника связи. Узел имеет то же имя, что и свойство исходной роли, но содержит начальный символ в нижнем регистре.

     Например, в определении DSL роль с именем " **люди** " является источником в классе **FamilyTree** .  В XML оно представлено узлом с именем `people` Nested внутри `familyTreeModel` узла.

- Целевой элемент каждой связи внедрения сериализуется как узел, вложенный в связь. Например, `people` узел содержит несколько `person` узлов.

- Целевой конец каждой ссылочной связи сериализуется как *моникер*, который кодирует ссылку на целевой элемент.

     Например, в `person` узле может существовать `children` связь. Этот узел содержит моникеры, такие как:

    ```xml
    <personMoniker name="/f817b728-e920-458e-bb99-98edc469d78f/Elizabeth I" />
    ```

## <a name="understand-monikers"></a>Общие сведения о моникерах

Моникеры используются для представления перекрестных ссылок между различными частями файлов модели и схемы. Они также используются в `.diagram` файле для ссылки на узлы в файле модели. Существует две формы моникера:

- *Моникеры идентификаторов* цитата. идентификатор GUID целевого элемента. Пример:

    ```xml
    <personShapeMoniker Id="f79734c0-3da1-4d72-9514-848fa9e75157" />
    ```

- *Уточненные моникеры ключей* определяют целевой элемент по значению указанного свойства домена, которое называется ключом моникера. Моникер целевого элемента имеет префикс моникера родительского элемента в дереве отношений встраивания.

     Следующие примеры взяты из DSL, в котором есть доменный класс «альбом», который имеет отношение внедрения к доменному классу «Song:

    ```xml
    <albumMoniker title="/My Favorites/Jazz after Teatime" />
    <songMoniker title="/My Favorites/Jazz after Teatime/Hot tea" />
    ```

     Специальные моникеры ключей будут использоваться, если целевой класс имеет свойство домена, для которого параметр **является ключом моникера** `true` в режиме **сериализации XML**. В этом примере этот параметр задан для свойств домена с именем Title в доменных классах «альбом» и «песня».

Специальные имена ключей легче читать, чем моникеры ИДЕНТИФИКАТОРов. Если вы собираетесь читать XML-файлы модели пользователями, рассмотрите возможность использования моникеров с полными ключами. Однако пользователю может быть присвоено несколько элементов, чтобы иметь один и тот же ключ моникера. Дублирование ключей может привести к неправильной перезагрузке файла. Таким образом, при определении доменного класса, на который имеются ссылки с использованием специальных имен ключей, следует рассмотреть способы предотвращения сохранения пользователем файла с повторяющимися моникерами.

### <a name="to-set-a-domain-class-to-be-referenced-by-id-monikers"></a>Установка на доменный класс, на который ссылаются моникеры ИДЕНТИФИКАТОРов

1. Убедитесь, что **ключ является ключом моникера** `false` для каждого свойства домена в классе и его базовых классах.

    1. В обозревателе DSL разверните узел **XML-сериализация Бехавиор\класс данные \\ \<the domain class> \елемент**.

    2. Убедитесь, что **ключ является ключом моникера** `false` для каждого свойства домена.

    3. Если класс домена имеет базовый класс, повторите процедуру в этом классе.

2. Задайте **идентификатор сериализации**  =  `true` для доменного класса.

     Это свойство можно найти в разделе **поведение сериализации XML**.

### <a name="to-set-a-domain-class-to-be-referenced-by-qualified-key-monikers"></a>Установка на доменный класс ссылок с указанием полных имен ключей

- Set **является ключом моникера** для свойства предметной области существующего доменного класса. Свойство должно иметь тип `string` .

    1. В обозревателе DSL разверните узел **XML-сериализация Бехавиор\класс данные \\ \<the domain class> \елемент**, а затем выберите свойство Domain.

    2. В окно свойств задайте для параметра **моникер** значение `true` .

- \- или -

     Создайте новый доменный класс с помощью средства **именованного доменного класса** .

     Это средство создает новый класс, имеющий свойство домена с именем Name. **— Это имя элемента** , а свойства **ключа моникера** для этого свойства домена инициализируются значением `true` .

- \- или -

     Создайте отношение наследования от доменного класса к другому классу, имеющему свойство ключа моникера.

### <a name="avoid-duplicate-monikers"></a>Избегайте дублирования моникеров

Если используются полные имена ключей, возможно, что два элемента в модели пользователя могут иметь одно и то же значение в ключевом свойстве. Например, если у вашего DSL есть класс Person с именем свойства, пользователь может задать одинаковые имена двух элементов. Несмотря на то, что модель может быть сохранена в файле, она перезагружена неправильно.

Существует несколько методов, которые помогают избежать такой ситуации:

- Задается **имя элемента**  =  `true` для ключевого свойства Domain. Выберите свойство Domain на схеме определения DSL, а затем задайте значение в окно свойств.

     Когда пользователь создает новый экземпляр класса, это значение приводит к тому, что свойству домена автоматически присваивается другое значение. Поведение по умолчанию добавляет число в конец имени класса. Это не мешает пользователю изменить имя на дубликат, но оно помогает в случае, если пользователь не задает значение перед сохранением модели.

- Включите проверку для DSL. В обозревателе DSL выберите Едитор\валидатион и задайте для параметра **использовать...** свойства значение `true` .

     Существует автоматически созданный метод проверки, который проверяет неоднозначность. Метод находится в `Load` категории проверки. Это гарантирует, что пользователь будет предупреждать о невозможности повторного открытия файла.

     Дополнительные сведения см. [в разделе Проверка на Domain-Specific языке](../modeling/validation-in-a-domain-specific-language.md).

### <a name="moniker-paths-and-qualifiers"></a>Пути и квалификаторы моникера

Уточненное специальное имя ключа заканчивается ключом моникера и дополняется моникером родительского элемента в дереве внедрения. Например, если моникер альбома:

```xml
<albumMoniker title="/My Favorites/Jazz after Teatime" />
```

Затем одной из композиций в этом альбоме может быть:

```xml
<songMoniker title="/My Favorites/Jazz after Teatime/Hot tea" />
```

Однако если вместо этого на альбомы ссылаются по ИДЕНТИФИКАТОРу, моникеры будут выглядеть следующим образом:

```xml
<albumMoniker Id="77472c3a-9bf9-4085-976a-d97a4745237c" />
<songMoniker title="/77472c3a-9bf9-4085-976a-d97a4745237c/Hot tea" />
```

Обратите внимание, что поскольку идентификатор GUID уникален, он никогда не предваряется моникером родительского элемента.

Если известно, что конкретное свойство предметной области всегда будет иметь уникальное значение внутри модели, можно установить для этого свойства **квалификатор моникера** `true` . Это приведет к тому, что он будет использоваться в качестве квалификатора без использования моникера родительского объекта. Например, если одновременно задан **квалификатор моникера** и **является ключом моникера** для свойства домен Title класса альбома, имя или идентификатор модели не используется в моникерах для альбома и его внедренных дочерних элементов:

```xml
<albumMoniker name="Jazz after Teatime" />
<songMoniker title="/Jazz after Teatime/Hot tea" />
```

## <a name="customize-the-structure-of-the-xml"></a>Настройка структуры XML

Чтобы внести следующие изменения, разверните узел **поведение сериализации XML** в обозревателе DSL. В классе домена разверните узел данных элемента, чтобы просмотреть список свойств и связей, источником которых является этот класс. Выберите связь и измените ее параметры в окно свойств.

- Установите для параметра **опущено** значение true, чтобы опустить узел исходной роли, в результате чего останется только список целевых элементов. Не следует устанавливать этот параметр, если между исходным и целевым классами существует несколько связей.

    ```xml
    <familyTreeModel ...>
      <!-- The following node is omitted by using Omit Element: -->
      <!-- <people> -->
        <person name="Henry VIII" .../>
        <person name="Elizabeth I" .../>
      <!-- </people> -->
    </familyTreeModel>
    ```

- Установите параметр **использовать полную форму** для внедрения целевых узлов в узлы, представляющие экземпляры отношений. Этот параметр задается автоматически при добавлении свойств домена в доменную связь.

    ```xml
    <familyTreeModel ...>
      <people>
        <!-- The following node is inserted by using Use Full Form: -->
        <familyTreeModelHasPeople myRelationshipProperty="x1">
          <person name="Henry VIII" .../>
        </familyTreeModelHasPeople>
        <familyTreeModelHasPeople myRelationshipProperty="x2">
          <person name="Elizabeth I" .../>
        </familyTreeModelHasPeople>
      </people>
    </familyTreeModel>
    ```

- Задайте   =  для **элемента** представления свойство домена, сохраненное как элемент, а не как значение атрибута.

    ```xml
    <person name="Elizabeth I" birthYear="1533">
      <deathYear>1603</deathYear>
    </person>
    ```

- Чтобы изменить порядок сериализации атрибутов и связей, щелкните правой кнопкой мыши элемент в разделе данные элемента и воспользуйтесь командами меню **вверх или** **вниз** .

## <a name="major-customization-using-program-code"></a>Основная настройка с помощью программного кода

Можно заменить части или все алгоритмы сериализации.

Рекомендуется изучить код в **Дсл\женератед коде\сериализер.КС** и **SerializationHelper.CS**.

### <a name="to-customize-the-serialization-of-a-particular-class"></a>Настройка сериализации определенного класса

1. В узле для этого класса в разделе **поведение сериализации XML** задано значение **Custom** .

2. Преобразование всех шаблонов, построение решения и исследование полученных ошибок компиляции. Комментарии рядом с каждой ошибкой объясняют, какой код необходимо предоставить.

### <a name="to-provide-your-own-serialization-for-the-whole-model"></a>Предоставление собственной сериализации для всей модели

1. Переопределение методов в Дсл\женератедкоде\сериализатионхелпер.КС

## <a name="options-in-xml-serialization-behavior"></a>Параметры в поведении XML-сериализации

В обозревателе DSL узел "поведение сериализации XML" содержит дочерний узел для каждого класса домена, отношения, формы, соединителя и схемы. В каждом из этих узлов находится список свойств и отношений, источником которых является этот элемент. Связи представлены как справа, так и в их исходных классах.

В следующей таблице перечислены параметры, которые можно задать в этом разделе определения DSL. В каждом случае выберите элемент в обозревателе DSL и задайте параметры в окно свойств.

### <a name="xml-class-data"></a>Данные класса XML

Эти элементы находятся в обозревателе DSL в разделе **XML Serialization Бехавиор\класс Data**.

|Свойство|Описание|
|-|-|
|Имеет пользовательскую схему элементов|Если значение — true, указывает, что класс домена имеет пользовательскую схему элементов|
|Является настраиваемым|Задайте значение **true** , если вы хотите написать собственный код сериализации и десериализации для этого доменного класса.<br /><br /> Постройте решение и изучите ошибки, чтобы найти подробные инструкции.|
|Доменный класс|Доменный класс, к которому применяется этот узел данных класса. Только для чтения.|
|Имя элемента|Имя XML-узла для элементов этого класса. Значение по умолчанию — это более строчная версия имени доменного класса.|
|Имя атрибута моникера|Имя атрибута, используемого в элементах моникера для хранения ссылки. Если оно пустое, используется имя ключевого свойства или идентификатор.<br /><br /> В этом примере это "имя":  `<personMoniker name="/Mike Nash"/>`|
|Имя элемента моникера|Имя XML-элемента, используемого для моникеров, ссылающихся на элементы этого класса.<br /><br /> Значение по умолчанию — строчная версия имени класса с суффиксом "моникер". Например, `personMoniker`.|
|Имя типа моникера|Имя XSD-типа, создаваемого для моникеров для элементов данного класса. XSD находится в **Дсл\женератед Code \\ \* Schema. xsd**|
|Идентификатор сериализации|Если значение — true, идентификатор GUID элемента включается в файл. Это должно быть истинно, если нет свойства, которое помечено как **ключ моникера** , а DSL определяет Ссылочные связи с этим классом.|
|Имя типа|Имя XML-типа, создаваемого в XSD из обозначенного доменного класса.|
|Примечания|Неформальные примечания, связанные с этим элементом|

### <a name="xml-property-data"></a>Данные свойства XML

Узлы свойств XML находятся в узлах классов.

|Свойство|Описание|
|-|-|
|Свойство домена|Свойство, к которому применяются данные конфигурации сериализации XML. Только для чтения.|
|Ключ моникера|Если значение — true, свойство используется в качестве ключа для создания моникеров, ссылающихся на экземпляры этого доменного класса.|
|Квалификатор моникера|Если значение равно true, свойство используется для создания квалификатора в моникерах. Если значение равно false, и если SerializeId имеет значение true для этого доменного класса, моникеры уточняются моникером родительского элемента в дереве внедрения.|
|Представление|Если значение равно Attribute, свойство сериализуется как XML-атрибут; если Element, оно сериализуется как элемент; если Ignore, оно не сериализуется.|
|Имя XML|Имя, используемое для XML-атрибута или элемента, представляющего свойство. По умолчанию это более строчная версия имени свойства домена.|
|Примечания|Неформальные примечания, связанные с этим элементом|

### <a name="xml-role-data"></a>Данные роли XML

Узлы данных ролей находятся в узлах исходного класса.

|Свойство|Описание|
|-|-|
|Имеет пользовательский моникер|Задайте значение true, если вы хотите предоставить собственный код для создания и разрешения моникеров, которые проходят через эту связь.<br /><br /> Для получения подробных инструкций выполните сборку решения, а затем дважды щелкните сообщения об ошибках.|
|Доменная связь|Указывает связь, к которой применяются эти параметры. Только для чтения.|
|Опустить элемент|Если значение — true, XML-узел, соответствующий исходной роли, опускается из схемы.<br /><br /> Если между исходным и целевым классами существует несколько связей, этот узел роли различает ссылки, принадлежащие двум связям. Поэтому в этом случае рекомендуется не задавать этот параметр.|
|Имя элемента роли|Задает имя XML-элемента, производного от исходной роли. Значение по умолчанию — имя свойства роли.|
|Использовать полную форму|Если значение — true, каждый целевой элемент или моникер заключен в XML-узел, представляющий связь. Это свойство должно иметь значение true, если связь имеет собственные свойства домена.|

## <a name="see-also"></a>См. также раздел

- [Перемещение по модели и обновление модели в коде программы](../modeling/navigating-and-updating-a-model-in-program-code.md)
- [Создание кода из доменного языка](../modeling/generating-code-from-a-domain-specific-language.md)
