---
title: Создание предметно-ориентированного языка на основе Windows Forms
description: Содержит сведения об использовании Windows Forms для отображения состояния модели предметно-ориентированного языка.
ms.date: 11/04/2016
ms.topic: how-to
author: JoshuaPartlow
ms.author: joshuapa
manager: jmartens
ms.custom: SEO-VS-2020
ms.workload:
- multiple
ms.openlocfilehash: 41c3ba299df1e6f9ce0e2848f7ffad59e5b3fbea
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99945413"
---
# <a name="create-a-windows-forms-based-domain-specific-language"></a>Создание языка Domain-Specific на основе Windows Forms

Windows Forms можно использовать для отображения состояния модели доменного языка (DSL) вместо использования схемы DSL. В этом разделе описывается привязка формы Windows Forms к домену DSL с помощью пакета SDK визуализации и моделирования Visual Studio.

На следующем рисунке показан пользовательский интерфейс Windows Form и обозреватель моделей для экземпляра DSL:

![Экземпляр DSL в Visual Studio](../modeling/media/dsl-wpf-2.png)

## <a name="create-a-windows-forms-dsl"></a>Создание Windows Forms DSL

Шаблон **минимального конструктора WinForm Designer** создает минимальный DSL, который можно изменить в соответствии с собственными требованиями.

1. Создайте DSL на основе **минимального шаблона конструктора WinForm** .

    В этом пошаговом руководстве предполагается использование следующих имен:

    - Имя решения и DSL: `FarmApp`
    - Пространство имен: `Company.FarmApp`

2. Поэкспериментируйте с исходным примером, который предоставляет шаблон:

   1. Преобразование всех шаблонов.

   2. Выполните сборку и запустите пример (**CTRL** + **F5**).

   3. В экспериментальном экземпляре Visual Studio откройте `Sample` файл в проекте отладки.

        Обратите внимание, что он отображается в элементе управления Windows Forms.

        Можно также просмотреть элементы модели, отображаемые в обозревателе.

        Добавьте некоторые элементы либо в форму, либо в обозреватель, и обратите внимание, что они отображаются в другом окне.

   В основном экземпляре Visual Studio Обратите внимание на следующие моменты, связанные с решением DSL:

- `DslDefinition.dsl` не содержит элементов диаграммы. Это обусловлено тем, что схемы DSL не будут использоваться для просмотра моделей экземпляров этого DSL. Вместо этого в модель будет привязана форма Windows Forms, а в элементах формы будет отображаться модель.

- Помимо `Dsl` `DslPackage` проектов и, решение содержит третий проект с именем `UI.` проект **пользовательского интерфейса** , содержащий определение элемента управления Windows Forms. `DslPackage` зависит от `UI` и `UI` зависит от `Dsl` .

- В `DslPackage` проекте `UI\DocView.cs` содержит код, отображающий элемент управления Windows Forms, определенный в `UI` проекте.

- `UI`Проект содержит рабочий пример элемента управления формы, привязанного к DSL. Однако он не будет работать после изменения определения DSL. `UI`Проект содержит:

  - Класс Windows Forms с именем `ModelViewControl` .

  - Файл с именем `DataBinding.cs` , содержащий дополнительное частичное определение `ModelViewControl` . Чтобы просмотреть его содержимое, в **Обозреватель решений** откройте контекстное меню для файла и выберите пункт **Просмотреть код**.

### <a name="about-the-ui-project"></a>Сведения о проекте пользовательского интерфейса

При обновлении файла определения DSL для определения собственного DSL необходимо обновить элемент управления в `UI` проекте, чтобы он отображался на языке DSL. В отличие от `Dsl` `DslPackage` проектов и, пример `UI` проекта не создается из `DslDefinitionl.dsl` . Можно добавить TT-файлы, чтобы создать код при необходимости, хотя это не рассматривается в этом пошаговом руководстве.

## <a name="update-the-dsl-definition"></a>Обновление определения DSL

На следующем рисунке показано определение DSL, используемое в этом пошаговом руководстве.

![Определение DSL](../modeling/media/dsl-wpf-1.png)

1. Откройте DslDefinition. DSL в конструкторе DSL.

2. Удалить **ексамплилемент**

3. Переименуйте доменный класс **пространстве ExampleModel** в `Farm` .

     Предоставьте ему дополнительные свойства домена с именем `Size` типа **Int32** и `IsOrganic` типом **Boolean**.

    > [!NOTE]
    > Если удалить класс корневого домена, а затем создать новый корень, потребуется сбросить свойство корневого класса редактора. В **обозревателе DSL** выберите **Редактор**. Затем в окно свойств задайте для **корневого класса** значение `Farm` .

4. Используйте средство **домен именованного класса** для создания следующих классов домена:

    - `Field` — Укажите это дополнительное свойство домена с именем `Size` .

    - `Animal` — В окно свойств задайте для **модификатора наследования** значение **abstract**.

5. Используйте средство **доменный класс** для создания следующих классов:

    - `Sheep`

    - `Goat`

6. Используйте средство **наследования** для создания `Goat` и `Sheep` наследования из `Animal` .

7. Используйте средство **внедрения** для внедрения `Field` и `Animal` в `Farm` .

8. Может потребоваться очистка схемы. Чтобы уменьшить количество повторяющихся элементов, используйте команду « **переместить поддерево** » в контекстном меню конечных элементов.

9. **Преобразовать все шаблоны** на панели инструментов Обозреватель решений.

10. Создайте проект **DSL** .

    > [!NOTE]
    > На этом этапе другие проекты не будут собираться без ошибок. Однако мы хотим создать проект DSL, чтобы его сборка была доступна в мастере источников данных.

## <a name="update-the-ui-project"></a>Обновление проекта пользовательского интерфейса

Теперь можно создать новый пользовательский элемент управления, который будет отображать сведения, хранящиеся в модели DSL. Самым простым способом подключения пользовательского элемента управления к модели является привязка данных. Тип адаптера привязки данных с именем **моделингбиндингсаурце** специально разработан для подключения DSL к интерфейсам, не ЯВЛЯЮЩИМСЯ для VMSDK.

### <a name="define-your-dsl-model-as-a-data-source"></a>Определение модели DSL в качестве источника данных

1. В меню **данные** выберите команду **отобразить источники данных**.

     Открывается окно **Источники данных**.

     Выберите **Добавить новый источник данных**. Откроется **Мастер настройки источника данных** .

2. Выберите **объект**, **Далее**.

     Разверните узел **DSL**, **Company. Фармапп** и выберите **ферма**, которая является корневым классом модели. Нажмите кнопку **Готово**.

     В обозреватель решений проект **пользовательского интерфейса** теперь содержит **пропертиес\датасаурцес\фарм.датасаурце**

     Свойства и связи класса модели отображаются в окне Источники данных.

     ![Окно "источники данных"](../modeling/media/dslwpf-3.png)

### <a name="connect-your-model-to-a-form"></a>Подключение модели к форме

1. В проекте **пользовательского интерфейса** удалите все существующие файлы. cs.

2. Добавьте новый файл **пользовательского элемента управления** с именем `FarmControl` в проект **пользовательского интерфейса** .

3. В окне **Источники данных** в раскрывающемся меню **фермы** выберите **сведения**.

    Оставьте параметры по умолчанию для других свойств.

4. Откройте FarmControl.cs в режиме конструктора.

    Перетащите **ферму** из окна Источники данных на фармконтрол.

    Появится набор элементов управления, по одному для каждого свойства. Свойства связи не создают элементы управления.

5. Удалите **фармбиндингнавигатор**. Это также автоматически создается в `FarmControl` конструкторе, но не полезно для этого приложения.

6. С помощью панели элементов создайте два экземпляра **DataGridView** и назовите их `AnimalGridView` и `FieldGridView` .

   > [!NOTE]
   > Другим шагом является перетаскивание элементов животных и Fields из окна Источники данных на элемент управления. Это действие автоматически создает сетки данных и привязки между представлением сетки и источником данных. Однако эта привязка неправильно работает для DSL. Поэтому лучше создавать сетки данных и привязки вручную.

7. Если панель элементов не содержит средство **моделингбиндингсаурце** , добавьте его. В контекстном меню вкладки **данные** выберите **пункт Выбрать элементы**. В диалоговом окне **Выбор элементов панели элементов** выберите **моделингбиндингсаурце** на вкладке **платформа .NET Framework** .

8. С помощью панели элементов создайте два экземпляра **моделингбиндингсаурце**, назовите их `AnimalBinding` и `FieldBinding` .

9. Задайте для свойства **DataSource** каждого **моделингбиндингсаурце** значение **фармбиндингсаурце**.

     Задайте для свойства **DataMember** значение **животные** или **Fields**.

10. Установите свойства **DataSource** `AnimalGridView` для `AnimalBinding` , и из в значение  `FieldGridView` `FieldBinding` .

11. Настройте макет элемента управления "ферма" на свой вкус.

    **Моделингбиндингсаурце** — это адаптер, который выполняет несколько функций, характерных для DSL:

- Он заключает обновления в транзакцию хранилища VMSDK.

   Например, когда пользователь удаляет строку из сетки представления данных, обычная привязка приведет к исключению транзакции.

- Это гарантирует, что когда пользователь выбирает строку, окно свойств отображает свойства соответствующего элемента модели вместо строки сетки данных.

  ![Схема привязки DSL](../modeling/media/dslwpf4.png)
  
  Схема связей между источниками данных и представлениями.

### <a name="complete-the-bindings-to-the-dsl"></a>Завершение привязки к DSL

1. Добавьте следующий код в отдельный файл кода в проекте **пользовательского интерфейса** :

    ```csharp
    using System.ComponentModel;
    using Microsoft.VisualStudio.Modeling;
    using Microsoft.VisualStudio.Modeling.Design;

    namespace Company.FarmApp
    {
      partial class FarmControl
      {
        public IContainer Components { get { return components; } }

        /// <summary>Binds the WinForms data source to the DSL model.
        /// </summary>
        /// <param name="nodelRoot">The root element of the model.</param>
        public void DataBind(ModelElement modelRoot)
        {
          WinFormsDataBindingHelper.PreInitializeDataSources(this);
          this.farmBindingSource.DataSource = modelRoot;
          WinFormsDataBindingHelper.InitializeDataSources(this);
        }
      }
    }
    ```

2. В проекте **DslPackage** измените значение **дслпаккаже\доквиев.ТТ** , чтобы обновить следующее определение переменной:

    ```csharp
    string viewControlTypeName = "FarmControl";
    ```

## <a name="test-the-dsl"></a>Тестирование DSL

Теперь решение DSL может быть построено и запущено, хотя в дальнейшем может потребоваться добавить дополнительные улучшения.

1. Выполните сборку и запуск решения.

2. В экспериментальном экземпляре Visual Studio откройте **Пример** файла.

3. В **обозревателе фармапп** откройте контекстное меню в корневом узле **фермы** и выберите **Добавить новый Гоат**.

     `Goat1` отображается в представлении **животные** .

    > [!WARNING]
    > Необходимо использовать контекстное меню узла **фермы** , а не узла **животные** .

4. Выберите корневой узел **фермы** и просмотрите его свойства.

     В представлении формы измените **имя** или **Размер** фермы.

     При переходе от каждого поля в форме соответствующее свойство изменяется в окно свойств.

## <a name="enhance-the-dsl"></a>Улучшение DSL

### <a name="make-the-properties-update-immediately"></a>Сделать свойства немедленно обновленными

1. В представлении конструирования FarmControl.cs выберите простое поле, например Name, Size или.

2. В окно свойств разверните элемент **DataBindings** и откройте **(дополнительно)**.

     В диалоговом окне **Форматирование и дополнительная привязка** в разделе **режим обновления источника данных** выберите **OnPropertyChanged**.

3. Выполните сборку и запуск решения.

     Убедитесь, что при изменении содержимого поля соответствующее свойство модели фермы изменяется немедленно.

### <a name="provide-add-buttons"></a>Укажите кнопки добавления

1. В представлении конструирования FarmControl.cs используйте панель элементов, чтобы создать кнопку в форме.

    Измените имя и текст кнопки, например, на `New Sheep` .

2. Откройте код программной части кнопки (например, дважды щелкнув ее).

    Измените его следующим образом:

   ```csharp
   private void NewSheepButton_Click(object sender, EventArgs e)
   {
     using (Transaction t = farm.Store.TransactionManager.BeginTransaction("Add sheep"))
     {
       elementOperations.MergeElementGroup(farm,
         new ElementGroup(new Sheep(farm.Partition)));
       t.Commit();
     }
   }

   // The following code is shared with other add buttons:
   private ElementOperations operationsCache = null;
   private ElementOperations elementOperations
   {
     get
     {
       if (operationsCache == null)
       {
         operationsCache = new ElementOperations(farm.Store, farm.Partition);
       }
       return operationsCache;
     }
   }
   private Farm farm
   {
     get { return this.farmBindingSource.DataSource as Farm; }
   }
   ```

    Кроме того, потребуется вставить следующую директиву:

   ```csharp

   using Microsoft.VisualStudio.Modeling;
   ```

3. Добавьте аналогичные кнопки для Гоатс и Fields.

4. Выполните сборку и запуск решения.

5. Убедитесь, что кнопка Создать добавляет элемент. Новый элемент должен отображаться как в обозревателе Фармапп, так и в соответствующем представлении сетки данных.

    Вы должны иметь возможность изменить имя элемента в представлении сетки данных. Кроме того, его можно удалить из него.

   ![Представление таблицы образцов данных](../modeling/media/dsl-wpf-2.png)

### <a name="about-the-code-to-add-an-element"></a>О коде для добавления элемента

Для новых кнопок элементов следующий альтернативный код немного проще.

```csharp
private void NewSheepButton_Click(object sender, EventArgs e)
{
  using (Transaction t = farm.Store.TransactionManager.BeginTransaction("Add sheep"))
  {
    farm.Animals.Add(new Sheep(farm.Partition)); ;
    t.Commit();
  }
}
```

Однако этот код не задает имя по умолчанию для нового элемента. Он не выполняет настроенное слияние, которое может быть определено в **директивах слияния элементов** DSL, и не выполняет пользовательский код слияния, который мог быть определен.

Поэтому рекомендуется использовать <xref:Microsoft.VisualStudio.Modeling.ElementOperations> для создания новых элементов. Дополнительные сведения см. в разделе [Настройка создания и перемещения элементов](../modeling/customizing-element-creation-and-movement.md).

## <a name="see-also"></a>См. также раздел

- [Определение языка Domain-Specific](../modeling/how-to-define-a-domain-specific-language.md)
- [Написание кода для настройки языка Domain-Specific](../modeling/writing-code-to-customise-a-domain-specific-language.md)
- [SDK моделирования для Visual Studio — доменные языки](../modeling/modeling-sdk-for-visual-studio-domain-specific-languages.md)
