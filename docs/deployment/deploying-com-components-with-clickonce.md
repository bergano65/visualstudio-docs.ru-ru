---
title: Развертывание COM-компонентов с помощью ClickOnce | Документация Майкрософт
description: Сведения о шагах, необходимых для развертывания приложений .NET в ClickOnce, содержащих устаревшие компоненты COM.
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: conceptual
dev_langs:
- VB
- CSharp
- C++
helpviewer_keywords:
- registration-free COM deployment
- ClickOnce deployment, COM components
- COM components, deploying
- deploying applications [ClickOnce], COM components
- components, deploying
ms.assetid: 1a4c7f4c-7a41-45f2-9af4-8b1666469b89
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: e2285706f2d15c5497a83d27c95cd613191e0fe4
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99893975"
---
# <a name="deploy-com-components-with-clickonce"></a>Развертывание компонентов COM с помощью ClickOnce
Развертывание устаревших COM-компонентов традиционно было сложной задачей. Компоненты должны быть глобально зарегистрированы, что может привести к нежелательным побочным эффектам между перекрывающимися приложениями. Эта ситуация обычно не является проблемой в платформа .NET Framework приложениях, поскольку компоненты полностью изолированы для приложения или совместимы друг с другом. Visual Studio позволяет развертывать изолированные компоненты COM в операционной системе Windows XP или более поздней версии.

 [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] предоставляет простой и надежный механизм развертывания приложений .NET. Однако если приложения используют устаревшие COM-компоненты, необходимо выполнить дополнительные действия по их развертыванию. В этом разделе описывается развертывание изолированных компонентов COM и ссылки на собственные компоненты (например, из Visual Basic 6,0 или Visual C++).

 Дополнительные сведения о развертывании изолированных COM-компонентов см. в статье [упрощение развертывания приложений с помощью ClickOnce и Registration-Free com](https://web.archive.org/web/20050326005413/msdn.microsoft.com/msdnmag/issues/05/04/RegFreeCOM/default.aspx).

## <a name="registration-free-com"></a>Не требующий регистрации COM
 COM без регистрации — это новая технология развертывания и активации изолированных COM-компонентов. Он работает путем помещения всех сведений о библиотеке типов и регистрации компонента, которые обычно устанавливаются в системный реестр, в XML-файл, называемый манифестом, который хранится в той же папке, что и приложение.

 Для изоляции компонента COM необходимо, чтобы он был зарегистрирован на компьютере разработчика, но не должен быть зарегистрирован на компьютере конечного пользователя. Чтобы изолировать COM-компонент, достаточно присвоить **изолированному** свойству ссылки **значение true**. По умолчанию это свойство имеет значение **false**, что означает, что оно должно рассматриваться как зарегистрированная ссылка COM. Если это свойство имеет **значение true**, это приводит к созданию манифеста для этого компонента во время сборки. Это также приводит к тому, что соответствующие файлы копируются в папку приложения во время установки.

 Когда генератор манифеста обнаруживает изолированную ссылку COM, он перечисляет все `CoClass` записи в библиотеке типов компонента, сопоставляя каждую запись с соответствующими регистрационными данными, а также создает определения манифеста для всех классов COM в файле библиотеки типов.

## <a name="deploy-registration-free-com-components-using-clickonce"></a>Развертывание COM-компонентов без регистрации с помощью ClickOnce
 [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] Технология развертывания хорошо подходит для развертывания изолированных COM-компонентов, так как [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] и com, без регистрации, требует, чтобы компонент имел манифест для развертывания.

 Как правило, автор компонента должен предоставить манифест. Однако в противном случае Visual Studio может автоматически создать манифест для COM-компонента. Создание манифеста выполняется во время [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] процесса публикации. Дополнительные сведения см. в статье [Публикация приложений ClickOnce](../deployment/publishing-clickonce-applications.md). Эта функция также позволяет использовать устаревшие компоненты, созданные в более ранних средах разработки, например Visual Basic 6,0.

 Существует два способа [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] развертывания COM-компонентов.

- Используйте начальный загрузчик для развертывания COM-компонентов; Это работает на всех поддерживаемых платформах.

- Используйте изолированное развертывание компонентов (также известное как модель COM без регистрации). Однако это будет работать только в операционной системе Windows XP или более поздней версии.

### <a name="example-of-isolating-and-deploying-a-simple-com-component"></a>Пример изоляции и развертывания простого компонента COM
 Чтобы продемонстрировать развертывание COM-компонентов без регистрации, в этом примере создается приложение Windows на Visual Basic, которое ссылается на изолированный собственный COM-компонент, созданный с помощью Visual Basic 6,0, и развертывает его с помощью [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] .

 Сначала необходимо создать собственный COM-компонент:

##### <a name="to-create-a-native-com-component"></a>Создание собственного COM-компонента

1. С помощью Visual Basic 6,0 в меню **файл** выберите пункт **создать**, а затем **проект**.

2. В диалоговом окне **Новый проект** выберите узел **Visual Basic** и выберите проект **DLL ActiveX** . В поле **Имя файла** введите `VB6Hello`.

    > [!NOTE]
    > С COM без регистрации поддерживаются только типы проектов ActiveX и элементов ActiveX. Типы проектов "ActiveX" и "документ ActiveX" не поддерживаются.

3. В **Обозреватель решений** дважды щелкните **Class1. vb** , чтобы открыть текстовый редактор.

4. В Class1. vb добавьте следующий код после созданного кода для `New` метода:

    ```vb
    Public Sub SayHello()
       MsgBox "Message from the VB6Hello COM component"
    End Sub
    ```

5. Создайте компонент. В меню **Сборка** выберите **Построить решение**.

> [!NOTE]
> COM без регистрации поддерживает только типы проектов DLL и элементы управления COM. Нельзя использовать exe с COM без регистрации.

 Теперь можно создать приложение на основе Windows и добавить в него ссылку на компонент COM.

##### <a name="to-create-a-windows-based-application-using-a-com-component"></a>Создание приложения на основе Windows с помощью COM-компонента

1. С помощью Visual Basic в меню **файл** выберите пункт **создать**, а затем **проект**.

2. В диалоговом окне **Новый проект** выберите узел **Visual Basic** и выберите **приложение Windows**. В поле **Имя файла** введите `RegFreeComDemo`.

3. В **Обозреватель решений** нажмите кнопку **Показать все файлы** , чтобы отобразить ссылки на проект.

4. Щелкните правой кнопкой мыши узел **ссылки** и выберите в контекстном меню команду **Добавить ссылку** .

5. В диалоговом окне **Добавление ссылки** перейдите на вкладку **Обзор** , перейдите к VB6Hello.dll, а затем выберите его.

    Ссылка на **VB6Hello** отображается в списке ссылок.

6. Наведите указатель на **область элементов**, выберите элемент управления **Button** и перетащите его в форму **Form1** .

7. В окне **Свойства** задайте для свойства **Text** кнопки значение **Привет**.

8. Дважды щелкните кнопку, чтобы добавить код обработчика и в файл кода добавьте код, чтобы обработчик зачитывается следующим образом:

   ```vb
   Private Sub Button1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button1.Click
       Dim VbObj As New VB6Hello.Class1
       VbObj.SayHello()
   End Sub
   ```

9. Запустите приложение. В меню **Отладка** выберите команду **Начать отладку**.

   Далее необходимо изолировать элемент управления. Каждый COM-компонент, используемый приложением, представлен в проекте как ссылка COM. Эти ссылки отображаются в узле **ссылки** в окне **Обозреватель решений** . (Обратите внимание, что можно добавить ссылки непосредственно с помощью команды **Добавить ссылку** в меню **проект** или косвенно, перетащив элемент управления ActiveX на форму.)

   В следующих шагах показано, как изолировать компонент COM и опубликовать обновленное приложение, содержащее изолированный элемент управления:

##### <a name="to-isolate-a-com-component"></a>Изолирование COM-компонента

1. В **Обозреватель решений** в узле **ссылки** выберите ссылку **VB6Hello** .

2. В окне **Свойства** измените значение **изолированного** свойства с **false** на **true**.

3. В меню **Сборка** выберите **Построить решение**.

   Теперь, когда вы нажмете клавишу F5, приложение работает должным образом, но теперь работает в среде COM без регистрации. Чтобы доказать это, попробуйте отменить регистрацию компонента VB6Hello.dll и запустить RegFreeComDemo1.exe за пределами интегрированной среды разработки Visual Studio. На этот раз при нажатии кнопки она по-прежнему работает. Если вы временно переименуйте манифест приложения, он снова завершится ошибкой.

> [!NOTE]
> Вы можете имитировать отсутствие COM-компонента, временно отменив его регистрацию. Откройте командную строку, перейдите в системную папку, введя `cd /d %windir%\system32` , а затем отмените регистрацию компонента, введя `regsvr32 /u VB6Hello.dll` . Вы можете зарегистрировать его еще раз, введя `regsvr32 VB6Hello.dll` .

 Заключительным этапом является публикация приложения с помощью [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] :

##### <a name="to-publish-an-application-update-with-an-isolated-com-component"></a>Публикация обновления приложения с помощью изолированного компонента COM

1. В меню **Сборка** выберите **опубликовать регфрикомдемо**.

    Откроется Мастер публикации.

2. В мастере публикации укажите расположение на диске локального компьютера, на котором можно получить доступ к опубликованным файлам и просмотреть их.

3. Нажмите кнопку **Готово**, чтобы опубликовать приложение.

   Если вы просматриваете опубликованные файлы, то Заметьте, что файл сисмон. ocx включен. Этот элемент управления полностью изолирован от этого приложения. Это означает, что если у компьютера конечного пользователя есть другое приложение, использующее другую версию элемента управления, это приложение не сможет помешать работе этого приложения.

## <a name="reference-native-assemblies"></a>Ссылки на машинные сборки
 Visual Studio поддерживает ссылки на сборки машинного кода Visual Basic 6,0 или C++; такие ссылки называются собственными ссылками. Определить, является ли ссылка собственной, можно, убедившись в том, что ее свойство **типа файла** имеет значение **native** или **ActiveX**.

 Чтобы добавить собственную ссылку, используйте команду **Добавить ссылку** , а затем перейдите к манифесту. Некоторые компоненты размещают манифест в библиотеке DLL. В этом случае можно просто выбрать саму библиотеку DLL, и Visual Studio добавит ее в качестве собственной ссылки, если обнаружит, что компонент содержит внедренный манифест. Visual Studio также автоматически включит все зависимые файлы или сборки, перечисленные в манифесте, если они находятся в той же папке, что и компонент, на который указывает ссылка.

 Изоляция элементов управления COM упрощает развертывание COM-компонентов, которые еще не имеют манифестов. Однако если компонент предоставляется с манифестом, вы можете ссылаться на манифест напрямую. На самом деле следует всегда использовать манифест, предоставленный автором компонента, везде, где это возможно, а не использовать **изолированное** свойство.

## <a name="limitations-of-registration-free-com-component-deployment"></a>Ограничения развертывания компонентов COM без регистрации
 COM без регистрации предоставляет четкие преимущества по сравнению с традиционными методами развертывания. Однако есть несколько ограничений и предостережений, на которые также следует обратить внимание. Наибольшее ограничение заключается в том, что оно работает только в Windows XP и более поздних версиях. Реализация COM без регистрации требует изменения способа загрузки компонентов в основную операционную систему. К сожалению, нет уровня поддержки нижнего уровня для COM без регистрации.

 Не все компоненты являются подходящим кандидатом для COM без регистрации. Компонент не подходит, если выполняется одно из следующих условий.

- Компонент является сервером вне процесса. Серверы EXE не поддерживаются; поддерживаются только библиотеки DLL.

- Компонент является частью операционной системы или является системным компонентом, таким как XML, Internet Explorer или Microsoft Data Access Components (MDAC). Необходимо следовать политике распространения автора компонента. обратитесь к поставщику.

- Компонент является частью приложения, например Microsoft Office. Например, не следует пытаться изолировать объектную модель Microsoft Excel. Это является частью Office и может использоваться только на компьютере с установленным полным продуктом Office.

- Компонент предназначен для использования в качестве надстройки или оснастки, например надстройки Office или элемента управления в веб-браузере. Для таких компонентов обычно требуется определенная схема регистрации, которая выходит за рамки самого манифеста.

- Компонент управляет физическим или виртуальным устройством для системы, например драйвером устройства для диспетчера очереди печати.

- Компонент — это распространяемый пакет доступа к данным. Приложениям для работы с данными обычно требуется отдельный распространяемый компонент доступа к данным, прежде чем их можно будет запустить. Не следует пытаться изолировать такие компоненты, как элемент управления данными Microsoft ADO, Microsoft OLE DB или Microsoft Data Access Components (MDAC). Вместо этого Если приложение использует компоненты MDAC или SQL Server Express, необходимо устанавливать их как необходимые компоненты; см. в разделе [как: Установка необходимых компонентов в дистрибутив приложения ClickOnce](../deployment/how-to-install-prerequisites-with-a-clickonce-application.md).

  В некоторых случаях разработчик компонента может иметь возможность переконструировать его для COM без регистрации. Если это невозможно, вы по-прежнему можете создавать и публиковать приложения, зависящие от них, используя стандартную схему регистрации с помощью загрузчика. Дополнительные сведения см. в разделе [Создание пакетов начального загрузчика](../deployment/creating-bootstrapper-packages.md).

  Компонент COM может быть изолирован только один раз для каждого приложения. Например, нельзя изолировать один и тот же COM-компонент из двух разных проектов **библиотеки классов** , которые являются частью одного приложения. Это приведет к выдаче предупреждения о сборке, и приложение не будет загружаться во время выполнения. Чтобы избежать этой проблемы, корпорация Майкрософт рекомендует инкапсулировать COM-компоненты в одной библиотеке классов.

  Существует несколько сценариев, в которых требуется регистрация COM на компьютере разработчика, даже если для развертывания приложения не требуется регистрация. `Isolated`Свойство требует, чтобы компонент COM был зарегистрирован на компьютере разработчика, чтобы автоматически создать манифест во время сборки. Нет возможностей записи регистрации, которые вызывают самостоятельную регистрацию во время сборки. Кроме того, любые классы, не определенные явно в библиотеке типов, не будут отражены в манифесте. При использовании COM-компонента с существующим манифестом, например машинной ссылкой, этот компонент может не требовать регистрации во время разработки. Однако регистрация необходима, если компонент является элементом управления ActiveX и его необходимо включить в **панель элементов** и конструктор Windows Forms.

## <a name="see-also"></a>См. также раздел
- [Развертывание и безопасность технологии ClickOnce](../deployment/clickonce-security-and-deployment.md)